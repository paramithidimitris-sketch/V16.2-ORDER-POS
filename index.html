<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>POS System v16.2</title>
<style>
:root {
  --bg-dark: #121212; --bg-card: #1e1e1e; --bg-muted: #2a2a2a; --text-light: #f0f0f0; --text-muted: #b0b0b0;
  --accent-yellow: #ffcc00; --accent-yellow-dark: #e6b800; --accent-yellow-light: #ffdd44;
  --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --blue: #3b82f6; --blue-dark: #1d4ed8;
  --border-dark: #333333; --border-light: #444444;
  --cat-1: #3a3a3a; --cat-2: #4a4a4a; --cat-3: #5a5a5a; --cat-4: #6a6a4a; --cat-5: #7a7a7a;
  --gray-100: #111111; --gray-200: #222222; --gray-300: #333333; --gray-400: #444444; --gray-500: #555555;
  --gray-600: #666666; --gray-700: #777777; --gray-800: #888888; --gray-900: #999999;
  --shadow: 0 4px 12px rgba(0,0,0,0.3); --shadow-heavy: 0 8px 24px rgba(0,0,0,0.5);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { width: 100%; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
body {
  margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg-dark); color: var(--text-light); line-height: 1.5; min-height: 100vh;
}

/* REPRINT MODAL */
.reprint-item {
  display: flex; align-items: center; gap: 10px; padding: 10px;
  border-bottom: 1px solid var(--gray-400);
}
.reprint-checkbox {
  width: 20px; height: 20px; accent-color: var(--accent-yellow);
}
.reprint-info { flex-grow: 1; }
.reprint-printed { font-size: 12px; color: var(--warning); }

/* EXISTING STYLES */
.btn {
  background: var(--gray-300); color: var(--text-light); border: 2px solid var(--border-dark); padding: 10px 16px; border-radius: 8px;
  cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s ease; display: inline-flex; align-items: center;
  justify-content: center; gap: 6px; white-space: nowrap;
}
.btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
.btn:active { transform: translateY(0); }
.btn.success { background: var(--success); color: white; border-color: var(--success); }
.btn.danger { background: var(--danger); color: white; border-color: var(--danger); }
.btn.dark { background: var(--gray-200); color: var(--text-light); border-color: var(--gray-400); }
.btn.ghost { background: transparent; border: 2px solid var(--gray-500); color: var(--text-light); }
.btn.accent { background: var(--accent-yellow); color: #000; border-color: var(--accent-yellow); font-weight: 700; }
.btn.danger-outline { background: transparent; color: var(--danger); border: 2px solid var(--danger); }
.btn-small { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; }
.hidden { display: none !important; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 20px; backdrop-filter: blur(5px); }
.modal.show { display: flex; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal-card {
  width: min(850px, 95vw); max-height: 90vh; overflow: hidden; background: var(--bg-card); border: 2px solid var(--accent-yellow);
  border-radius: 16px; padding: 20px; box-shadow: var(--shadow-heavy); display: flex; flex-direction: column;
}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--gray-400); }
.modal-content { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
.toast {
  position: fixed; top: 20px; right: 20px; background: rgba(34, 34, 34, 0.95); color: var(--text-light); border: 2px solid var(--accent-yellow);
  border-radius: 10px; padding: 14px 18px; font-weight: 600; box-shadow: var(--shadow-heavy); z-index: 1000; display: none; backdrop-filter: blur(10px);
}
.toast.show { display: block; animation: slideIn 0.3s ease; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.toast.success { background: rgba(34, 197, 94, 0.95); color: white; border-color: var(--success); }
.toast.warn { background: rgba(245, 158, 11, 0.95); color: #1d1406; border-color: var(--warning); }
.toast.danger { background: rgba(239, 68, 68, 0.95); color: white; border-color: var(--danger); }
.toast.info { background: rgba(30, 30, 30, 0.95); color: var(--text-light); border-color: var(--accent-yellow); }
.topbar {
  display: flex; align-items: center; justify-content: space-between; padding: 16px 20px;
  background: var(--gray-100); border-bottom: 2px solid var(--accent-yellow); position: sticky; top: 0; z-index: 100;
}
h1, h2, h3, h4 { margin: 0; font-weight: 600; color: var(--text-light); }
h1 { font-size: 22px; color: var(--accent-yellow); }
.page { padding: 20px; max-width: 1400px; margin: 0 auto; }
.heading-line { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
.heading-actions { display: inline-flex; gap: 10px; flex-wrap: wrap; }
.tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 16px; padding-right: 5px; }
.table-btn {
  padding: 20px 12px; border-radius: 12px; border: 2px solid var(--border-dark); background: var(--bg-card); color: var(--text-light);
  cursor: pointer; transition: all 0.2s ease; position: relative; text-align: center; font-weight: 600; font-size: 16px;
  min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;
}
.table-btn.free { border-color: var(--success); box-shadow: 0 0 0 1px var(--success); }
.table-btn.busy { border-color: var(--warning); box-shadow: 0 0 0 1px var(--warning); }
.table-btn.takeaway { border: 2px solid var(--accent-yellow); background: transparent; color: var(--accent-yellow); font-weight: 700; }
.table-btn:hover { transform: translateY(-3px); box-shadow: var(--shadow-heavy); }
.table-total { position: absolute; right: 10px; bottom: 8px; font-size: 13px; color: var(--text-muted); font-weight: 500; }
.tabs { margin: 20px 0; display: flex; gap: 8px; flex-wrap: wrap; border-bottom: 2px solid var(--gray-300); padding-bottom: 10px; }
.tab {
  background: var(--gray-200); border: 2px solid var(--gray-400); color: var(--text-muted); padding: 10px 16px; border-radius: 8px;
  cursor: pointer; font-size: 14px; text-transform: uppercase; font-weight: 600; transition: all 0.2s ease;
}
.tab.active { background: var(--accent-yellow); color: #000; border-color: var(--accent-yellow); box-shadow: 0 4px 12px rgba(255, 204, 0, 0.2); }
.tab:hover:not(.active) { border-color: var(--accent-yellow); color: var(--accent-yellow); }
.content { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-top: 20px; }
.catalog, .cart-area { background: var(--bg-card); border: 2px solid var(--gray-300); border-radius: 12px; padding: 16px; box-shadow: var(--shadow); }
.product-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
.product {
  background: var(--gray-200); border: 2px solid var(--gray-400); border-radius: 10px; padding: 12px; cursor: pointer;
  transition: all 0.2s ease; color: var(--text-light); box-shadow: var(--shadow);
  min-height: 90px; display: flex; flex-direction: column; justify-content: space-between; align-items: center;
}
.product:hover { transform: translateY(-2px); border-color: var(--accent-yellow); box-shadow: 0 6px 16px rgba(0,0,0,0.3); }
.product.active { border-color: var(--accent-yellow); background: rgba(255, 204, 0, 0.1); }
.product.decaf { background: var(--gray-300); border-color: var(--gray-500); background: linear-gradient(135deg, var(--gray-300) 0%, #5d4037 100%); }
.product-title { font-weight: 600; margin-bottom: 4px; color: var(--text-light); text-align: center; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
.product-price { color: var(--accent-yellow); font-size: 14px; font-weight: 600; text-align: center; width: 100%; }
.product.added-to-cart { animation: pulseCart 0.5s ease; border-color: var(--success); }
@keyframes pulseCart { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
.cart-list { list-style: none; margin: 0; padding: 0; max-height: 350px; overflow-y: auto; border: 1px solid var(--gray-400); border-radius: 8px; padding: 5px; }
.cart-item {
  display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: start; padding: 12px;
  border-bottom: 1px dashed var(--gray-400); cursor: pointer; transition: background 0.2s;
}
.cart-item:last-child { border-bottom: none; }
.cart-item.printed { opacity: 0.6; cursor: default; }
.cart-item:hover:not(.printed) { background: var(--gray-300); }
.cart-item .meta { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
.cart-item .actions { display: flex; align-items: center; gap: 8px; }
.cart-item .btn { padding: 6px 10px; font-size: 12px; background: var(--gray-300); border-color: var(--gray-500); }
.cart-item .remove { background: transparent; color: var(--danger); border: 1px solid var(--danger); min-width: 30px; }
.cart-item .edit-item { background: transparent; color: var(--warning); border: 1px solid var(--warning); min-width: 30px; }
.cart-item .remove:hover { background: var(--danger); color: white; }
.cart-item .edit-item:hover { background: var(--warning); color: white; }
.total { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; font-size: 18px; font-weight: 700; color: var(--accent-yellow); border-top: 2px solid var(--gray-400); margin-top: 10px; }
.cart-actions { display: flex; gap: 12px; margin-top: 15px; justify-content: flex-end; }
.modifiers .block { border: 2px solid var(--gray-400); border-radius: 10px; padding: 12px; margin-bottom: 12px; background: var(--gray-200); }
.modifiers .block.cat-1 { border-left: 4px solid var(--accent-yellow); }
.modifiers .block.cat-2 { border-left: 4px solid var(--warning); }
.modifiers .block.cat-3 { border-left: 4px solid var(--success); }
.modifiers .block.cat-4 { border-left: 4px solid var(--danger); }
.modifiers .block.cat-5 { border-left: 4px solid var(--gray-500); }
.modifiers .row { margin: 10px 0; } .modifiers .row.inline { display: flex; align-items: center; gap: 10px; }
.modifiers .checkbox-row { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
.modifiers .checkbox-row label { display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; color: var(--text-light); font-size: 14px; white-space: nowrap; }
.modifiers .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; margin: 0; accent-color: var(--accent-yellow); flex-shrink: 0; }
.chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
.chip {
  background: var(--gray-300); border: 2px solid var(--gray-400); color: var(--text-muted); padding: 8px 14px; border-radius: 20px;
  cursor: pointer; font-size: 13px; font-weight: 600; text-transform: uppercase; transition: all 0.2s; white-space: nowrap;
}
.chip.active { background: var(--accent-yellow); color: #000; border-color: var(--accent-yellow); }
.chip:hover { transform: translateY(-1px); border-color: var(--accent-yellow); }
.qty-control { display: flex; gap: 12px; align-items: center; margin: 20px 0; }
.qty-control label { margin: 0; min-width: 90px; color: var(--accent-yellow); font-weight: 600; }
.qty-control input { width: 80px; background: var(--gray-200); color: var(--text-light); border: 2px solid var(--accent-yellow); border-radius: 8px; padding: 12px; text-align: center; font-size: 20px; font-weight: bold; }
.qty-control button { background: var(--accent-yellow); color: #000; border: none; padding: 14px 18px; border-radius: 8px; cursor: pointer; font-size: 20px; font-weight: bold; min-width: 50px; transition: all 0.2s; }
.qty-control button:hover { background: var(--accent-yellow-dark); }
.legend { display: flex; align-items: center; gap: 16px; font-size: 14px; color: var(--text-muted); }
.legend .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
.legend .free { background: var(--success); } .legend .busy { background: var(--warning); }
.permanent-note { margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--gray-400); }
label { display: block; font-size: 14px; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; }
textarea, input, select {
  width: 100%; resize: vertical; background: var(--gray-200); color: var(--text-light); border: 2px solid var(--gray-400);
  border-radius: 8px; padding: 10px; font-family: inherit; font-size: 14px;
}
textarea:focus, input:focus, select:focus { outline: none; border-color: var(--accent-yellow); box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.2); }
.empty-cart { text-align: center; padding: 40px 20px; color: var(--text-muted); font-style: italic; font-size: 16px; }
.quick-actions-bar { display: flex; gap: 16px; margin: 20px 0; padding: 15px 0; justify-content: center; flex-wrap: wrap; border-top: 2px solid var(--gray-400); border-bottom: 2px solid var(--gray-400); }
.quick-actions-bar .btn { padding: 14px 28px; font-size: 16px; font-weight: 700; min-width: 160px; display: flex; align-items: center; justify-content: center; gap: 10px; }
#openCartBtn { background: transparent; color: var(--accent-yellow); border: 2px solid var(--accent-yellow); }
#openCartBtn:hover { background: var(--accent-yellow); color: #000; }
.cart-badge-container { position: relative; display: inline-block; }
.cart-badge {
  position: absolute; top: -8px; right: -8px; background-color: var(--danger); color: white; border-radius: 50%; padding: 4px 9px;
  font-size: 12px; font-weight: 900; min-width: 24px; text-align: center; line-height: 1.5; box-shadow: 0 0 0 3px var(--bg-card); z-index: 10; animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
.catalog-admin-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed var(--gray-400); }
.catalog-admin-item .product-info { flex-grow: 1; display: flex; align-items: center; gap: 12px; }
.catalog-admin-item .drag-handle { cursor: grab; padding: 8px 4px; color: var(--text-muted); opacity: 0.7; transition: opacity 0.2s; font-size: 18px; flex-shrink: 0; }
.catalog-admin-item .drag-handle:hover { opacity: 1; color: var(--accent-yellow); }
.catalog-admin-item .product-name { font-weight: 600; margin: 0; flex: 1; }
.catalog-admin-item .product-details { font-size: 13px; color: var(--text-muted); white-space: nowrap; }
.catalog-admin-item .actions { display: flex; gap: 8px; flex-shrink: 0; }
.device-name-section { margin: 25px 0; padding: 20px; background: var(--bg-muted); border-radius: 12px; border-left: 4px solid var(--accent-yellow); border-top: 1px solid var(--gray-400); }
.import-export-buttons { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; justify-content: center; }
.btn.export { background: transparent; color: var(--accent-yellow); border: 2px solid var(--accent-yellow); }
.btn.export:hover { background: var(--accent-yellow); color: #000; }
.btn.import { background: transparent; color: var(--success); border: 2px solid var(--success); }
.btn.import:hover { background: var(--success); color: white; }
.btn.clear { background: transparent; color: var(--danger); border: 2px solid var(--danger); }
.btn.clear:hover { background: var(--danger); color: white; }
.file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
.file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
.transfer-option-btn {
  background: var(--gray-200); border: 2px solid var(--gray-400); border-radius: 12px; padding: 20px 16px; cursor: pointer;
  transition: all 0.2s ease; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 8px; min-height: 120px; width: 100%;
}
.transfer-option-btn:hover { transform: translateY(-3px); border-color: var(--accent-yellow); box-shadow: var(--shadow); }
.transfer-option-btn .option-title { font-weight: 700; font-size: 18px; color: var(--text-light); margin-bottom: 5px; }
.transfer-option-btn .option-desc { font-size: 13px; color: var(--text-muted); line-height: 1.4; text-align: center; }
.transfer-option-btn.multi { background: var(--gray-300); border-color: var(--accent-yellow); }
.transfer-option-btn.multi:hover { background: rgba(255, 204, 0, 0.1); }
.transfer-checkbox { width: 20px; height: 20px; margin-right: 10px; accent-color: var(--accent-yellow); flex-shrink: 0; }
.transfer-item-selectable { display: flex; align-items: center; cursor: pointer; }
.transfer-item-selectable:hover { background: var(--gray-300); }

/* TWO COLUMNS MOBILE */
.two-columns-mobile {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 15px;
}
.modifiers-column {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
#modifiersModalContent .chips {
  display: flex !important;
  flex-direction: column !important;
  gap: 6px !important;
  margin-top: 5px !important;
}
#modifiersModalContent .chip {
  width: 100% !important;
  padding: 8px 10px !important;
  font-size: 12px !important;
  text-align: center !important;
  white-space: nowrap !important;
  overflow: visible !important;
  box-sizing: border-box !important;
}

/* RESPONSIVE */
@media (max-width: 1024px) { .content { grid-template-columns: 1fr; gap: 16px; } .tables-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); } }
@media (max-width: 768px) {
  .topbar { flex-direction: column; align-items: flex-start; gap: 12px; padding: 12px 16px; }
  .page { padding: 12px; }
  .heading-line { flex-direction: column; align-items: flex-start; gap: 12px; }
  .heading-actions { width: 100%; justify-content: flex-start; }
  .tables-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
  .table-btn { padding: 16px 8px; font-size: 14px; min-height: 90px; }
  .tabs { flex-wrap: wrap; justify-content: center; }
  .tab { font-size: 13px; padding: 8px 12px; flex: 1; min-width: 120px; text-align: center; }
  .product-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
  .quick-actions-bar { flex-direction: column; align-items: stretch; gap: 10px; }
  .quick-actions-bar .btn { min-width: 100%; padding: 12px 16px; font-size: 14px; }
  .cart-actions { flex-direction: column; }
  .cart-actions .btn { width: 100%; }
  .modal-card { padding: 16px; width: 95vw; }
  .modal-header { flex-direction: column; align-items: flex-start; gap: 10px; }
  .modal-header h3 { font-size: 18px; }
  .btn { padding: 8px 12px; font-size: 13px; }
  .qty-control button { padding: 12px 14px; min-width: 45px; font-size: 18px; }
  .qty-control input { width: 60px; padding: 10px; }
  .ai-btn { width: 50px; height: 50px; bottom: 15px; right: 15px; font-size: 20px; }
  .ai-status { bottom: 75px; right: 15px; font-size: 12px; }
  .two-columns-mobile { gap: 15px; }
}
@media (max-width: 480px) {
  .tables-grid, .product-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }
  .table-btn { padding: 14px 6px; font-size: 13px; min-height: 80px; }
  .product { padding: 10px; min-height: 80px; }
  .product-title { font-size: 14px; }
  .product-price { font-size: 12px; }
  .btn-small { padding: 5px 10px; font-size: 11px; }
  .legend { font-size: 12px; gap: 12px; }
}
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--gray-200); border-radius: 4px; }
::-webkit-scrollbar-thumb { background: var(--gray-500); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--gray-600); }
.page, .modal-content, .cart-list, .product-grid { -webkit-overflow-scrolling: touch; overflow-x: hidden; }

/* MODIFIERS SPECIFIC STYLES */
.modifiers .checkbox-row { display: flex; align-items: center; margin: 12px 0; }
.modifiers .checkbox-row label { display: flex; flex-direction: row-reverse; justify-content: flex-end; align-items: center; gap: 10px; cursor: pointer; }
.modifiers .checkbox-row input[type="checkbox"] { order: -1; margin-right: 0; }
.modifiers .chips + .checkbox-row:first-child { margin-top: 25px; padding-top: 15px; border-top: 1px dashed var(--gray-400); }
.modifiers .category-title { font-weight: 700; margin-bottom: 10px; padding: 8px 0; display: flex; align-items: center; gap: 8px; color: var(--accent-yellow) !important; border-left: none; background: none !important; }
.modifiers .category-title::before { font-size: 16px; color: var(--accent-yellow); }
#modifiersModalContent .checkbox-row { display: flex !important; align-items: center !important; flex-direction: row !important; margin: 12px 0 !important; }
#modifiersModalContent .checkbox-row label { display: flex !important; align-items: center !important; flex-direction: row !important; width: 100% !important; margin: 0 !important; }
#modifiersModalContent .checkbox-row input[type="checkbox"] { order: -1 !important; margin-right: 12px !important; width: 20px !important; height: 20px !important; flex-shrink: 0 !important; }
#modifiersModalContent .modifiers .row > label, #modifiersModalContent .modifiers .category-title, #modifiersModalContent .category-title { color: #ffcc00 !important; color: var(--accent-yellow) !important; font-weight: bold !important; font-size: 15px !important; background: transparent !important; border: none !important; margin-bottom: 10px !important; padding: 8px 0 !important; }
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
<div id="app">
<header class="topbar"><h1>POS System v16.2</h1>
  <div class="legend"><span class="dot free"></span>Î•Î»ÎµÏÎ¸ÎµÏÎ¿<span class="dot busy"></span>Î‘Î½Î¿Î¹ÎºÏ„ÏŒ/Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</div>
</header>
<section class="page" id="tablesView">
  <div class="heading-line"><h2>Î¤ÏÎ±Ï€Î­Î¶Î¹Î±</h2>
    <div class="heading-actions">
      <button class="btn dark btn-small" id="btnAdmin">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·</button>
      <button class="btn dark btn-small" id="btnDiscount">Î‘Ï†Î±Î¯ÏÎµÏƒÎ·</button>
      <button class="btn danger-outline btn-small" id="btnEndShift">Î¤Î­Î»Î¿Ï‚ Î’Î¬ÏÎ´Î¹Î±Ï‚</button>
    </div>
  </div>
  <div class="tables-grid" id="tablesGrid"></div>
</section>
<section class="page hidden" id="orderView">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="btn ghost" id="backToTables">â† Î Î¯ÏƒÏ‰</button>
      <h2 id="tableTitle" style="margin:0">Î¤ÏÎ±Ï€Î­Î¶Î¹</h2>
    </div>
    <div class="order-actions" style="display:flex;gap:10px">
      <button class="btn dark" id="transferTable">ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬</button>
      <button class="btn danger-outline" id="closeTable">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï</button>
      <button class="btn accent" id="reprintBtn" title="Î•Ï€Î±Î½ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ· ÎµÎºÏ„Ï…Ï€Ï‰Î¼Î­Î½Ï‰Î½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½">ğŸ”„ Î•Ï€Î±Î½.</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" data-tab="coffee">ÎšÎ±Ï†Î­Î´ÎµÏ‚ / Î¡ÏŒÏ†Î·Î¼Î±</button>
    <button class="tab" data-tab="soft">Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬</button>
    <button class="tab" data-tab="juices">Î§Ï…Î¼Î¿Î¯</button>
    <button class="tab" data-tab="drinks">Î Î¿Ï„Î¬</button>
    <button class="tab" data-tab="food">Î¦Î±Î³Î·Ï„ÏŒ / Î“Î»Ï…ÎºÏŒ</button>
  </div>
  <div class="quick-actions-bar">
    <button class="btn" id="openCartBtn"><span>ğŸ›’</span> ÎšÎ±Î»Î¬Î¸Î¹<div class="cart-badge-container"><span class="cart-badge hidden" id="cartBadge">0</span></div></button>
    <button class="btn success" id="quickPrintBtn"><span>ğŸ–¨ï¸</span> Î†Î¼ÎµÏƒÎ· Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
  </div>
  <div class="content">
    <div class="catalog"><div class="product-grid" id="products"></div></div>
    <div class="cart-area">
      <h3>Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</h3>
      <ul class="cart-list" id="cartList"></ul>
      <div class="total"><span>Î£ÏÎ½Î¿Î»Î¿:</span><strong id="cartTotal">0.00â‚¬</strong></div>
      <div class="cart-actions">
        <button class="btn success" id="printNow">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
        <button class="btn danger" id="clearDraft">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
      </div>
      <div class="permanent-note">
        <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± ÏŒÎ»Î· Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±:</label>
        <textarea id="orderNote" placeholder="Î“ÏÎ¬ÏˆÎµ ÎµÎ´Ï Î³ÎµÎ½Î¹ÎºÎ­Ï‚ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±" rows="2"></textarea>
      </div>
    </div>
  </div>
</section>
</div>

<!-- MODALS -->
<div class="toast" id="toast"></div>
<div class="modal" id="modifiersModal"><div class="modal-card">
  <div class="modal-header"><h3 id="modifiersModalTitle">Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹ Î ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚</h3><button class="btn ghost" id="closeModifiers">âœ•</button></div>
  <div class="modal-content" id="modifiersModalContent"></div>
  <div class="modifiers-sticky-footer"><button class="btn success" id="modalAddToCart" style="flex: 1;">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿ ÎšÎ±Î»Î¬Î¸Î¹</button></div>
</div></div>
<div class="modal" id="cartModal"><div class="modal-card">
  <div class="modal-header"><h3>ÎšÎ±Î»Î¬Î¸Î¹ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</h3><button class="btn ghost" id="closeCart">âœ•</button></div>
  <div class="modal-content" id="cartModalContent"></div>
</div></div>
<div class="modal" id="takeawayModal"><div class="modal-card">
  <div class="modal-header"><h3>Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î Î±ÎºÎ­Ï„Î¿Ï…</h3><button class="btn ghost" id="takeawayCancel">âœ•</button></div>
  <div class="modal-content">
    <h4>Î•Ï€Î¹Î»Î¿Î³Î® Î Î¿ÏƒÎ¿Ï</h4>
    <div class="product-grid" id="takeawayPrices">
      <button class="product" data-price="0.50">0.50â‚¬</button><button class="product" data-price="2.00">2.00â‚¬</button>
      <button class="product" data-price="2.50">2.50â‚¬</button><button class="product" data-price="3.00">3.00â‚¬</button>
      <button class="product" data-price="3.50">3.50â‚¬</button><button class="product" data-price="4.00">4.00â‚¬</button>
      <button class="product" data-price="6.00">6.00â‚¬</button>
      <input class="product" id="takeawayCustomPrice" placeholder="â‚¬" type="number">
    </div>
    <label for="takeawayText">Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</label>
    <textarea id="takeawayText" placeholder="Î“ÏÎ¬ÏˆÎµ ÎµÎ´Ï Ï„Î¹Ï‚ Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ Ï„Î·Ï‚ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚..." rows="4"></textarea>
  </div>
  <div class="modal-actions"><button class="btn success" id="takeawayPrint">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· Î Î±ÎºÎ­Ï„Î¿Ï…</button></div>
</div></div>
<div class="modal" id="transferModal"><div class="modal-card">
  <div class="modal-header"><h3 id="transferModalTitle">ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</h3><button class="btn ghost" id="transferCancel">âœ•</button></div>
  <div class="modal-content" id="transferModalContent"></div>
  <div class="modal-actions">
    <button class="btn success hidden" id="transferNextBtn">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿</button>
    <button class="btn success hidden" id="transferConfirmBtn">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬Ï‚</button>
  </div>
</div></div>
<div class="modal" id="pinModal"><div class="modal-card">
  <div class="modal-header"><h3 id="pinModalTitle">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® PIN</h3><button class="btn ghost" id="pinCancel">âœ•</button></div>
  <div class="modal-content centered"><p>Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ PIN Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ.</p><input id="pinInput" maxlength="4" type="password"></div>
  <div class="modal-actions"><button class="btn success" id="pinOk">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</button></div>
</div></div>
<div class="modal" id="catalogModal"><div class="modal-card">
  <div class="modal-header"><h3>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎšÎ±Ï„Î±Î»ÏŒÎ³Î¿Ï…</h3><button class="btn ghost" id="catalogModalClose">âœ•</button></div>
  <div class="modal-content">
    <div class="catalog-actions-container">
      <button class="btn accent" id="addProductBtn">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚</button>
      <button class="btn dark btn-small" id="resetCatalogBtn">Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎšÎ±Ï„Î±Î»ÏŒÎ³Î¿Ï…</button>
    </div>
    <div class="import-export-buttons">
      <button class="btn clear" id="clearCatalogBtn">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÎšÎ±Ï„Î±Î»ÏŒÎ³Î¿Ï…</button>
      <div class="file-input-wrapper"><button class="btn import" id="importCatalogBtn">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ÎšÎ±Ï„Î±Î»ÏŒÎ³Î¿Ï…</button>
        <input type="file" id="catalogFileInput" accept=".json" style="display: none;"></div>
      <button class="btn export" id="exportCatalogBtn">Î•Î¾Î±Î³Ï‰Î³Î® ÎšÎ±Ï„Î±Î»ÏŒÎ³Î¿Ï…</button>
    </div>
    <div class="device-name-section">
      <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--accent-yellow);">ğŸ“› ÎŸÎ½Î¿Î¼Î±ÏƒÎ¯Î± Î£Ï…ÏƒÎºÎµÏ…Î®Ï‚</h4>
      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <input type="text" id="deviceNameInput" placeholder="ORDER_POS" style="flex: 1; padding: 12px; background: var(--gray-200); border: 2px solid var(--accent-yellow); border-radius: 8px; color: var(--text-light); font-size: 16px;">
        <button class="btn accent" id="saveDeviceNameBtn" style="padding: 12px 20px;">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      </div>
      <p style="font-size: 13px; color: var(--text-muted); margin: 5px 0 0 0;">Î¤Î¿ ÏŒÎ½Î¿Î¼Î± Î¸Î± ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¹Ï‚ ÎµÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚ Ï‰Ï‚: <strong id="currentDeviceNamePreview" style="color: var(--accent-yellow);">ORDER_POS</strong></p>
    </div>
    <div id="catalogListContainer"></div>
  </div>
</div></div>
<div class="modal" id="productFormModal"><div class="modal-card">
  <div class="modal-header"><h3 id="productFormTitle">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚</h3><button class="btn ghost" id="productFormClose">âœ•</button></div>
  <div class="modal-content">
    <div class="admin-form">
      <input id="productId" type="hidden">
      <div><h4>ÎŒÎ½Î¿Î¼Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚</h4><input id="productName" placeholder="Î .Ï‡. Freddo Espresso" required type="text"></div>
      <div><h4>Î¤Î¹Î¼Î®</h4><input id="productPrice" placeholder="Î .Ï‡. 3.50" required step="0.01" type="number"></div>
      <div><h4>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</h4><select id="productCategory" required>
        <option value="coffee">ÎšÎ±Ï†Î­Î´ÎµÏ‚ / Î¡ÏŒÏ†Î·Î¼Î±</option><option value="soft">Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬</option>
        <option value="juices">Î§Ï…Î¼Î¿Î¯</option><option value="drinks">Î Î¿Ï„Î¬</option><option value="food">Î¦Î±Î³Î·Ï„ÏŒ / Î“Î»Ï…ÎºÏŒ</option>
      </select></div>
      <div><h4>Î•Ï„Î¹ÎºÎ­Ï„Î± (Tag) <small>(Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</small></h4><input id="productTag" placeholder="Î .Ï‡. coffee, decaf, drinks, ice" type="text"></div>
    </div>
  </div>
  <div class="modal-actions"><button class="btn success" id="saveProductBtn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button></div>
</div></div>
<div class="modal" id="reprintModal"><div class="modal-card">
  <div class="modal-header"><h3>ğŸ”„ Î•Ï€Î±Î½ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ· Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</h3><button class="btn ghost" id="closeReprint">âœ•</button></div>
  <div class="modal-content" id="reprintContent"></div>
  <div style="display:flex;gap:10px;margin-top:20px">
    <button class="btn success" id="reprintSelected">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½</button>
    <button class="btn dark" id="reprintAll">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· ÎŒÎ»Ï‰Î½</button>
  </div>
</div></div>

<script>
// =============== UTILITIES ===============
const euro = (v) => `${parseFloat(v).toFixed(2)}â‚¬`;
const byId = (x) => document.getElementById(x);
const qs = (sel, el = document) => el.querySelector(sel);
const qsa = (sel, el = document) => [...el.querySelectorAll(sel)];
const showEl = (el) => el.classList.remove('hidden');
const hideEl = (el) => el.classList.add('hidden');
function showToast(text, kind='info', ms=3000) { 
  const t = byId('toast'); 
  t.textContent = text; 
  t.className = 'toast show ' + kind; 
  setTimeout(() => t.className = 'toast', ms); 
}
function addClickEffect(el) { 
  if (el) { 
    el.classList.add('added-to-cart-effect'); 
    setTimeout(() => el.classList.remove('added-to-cart-effect'), 600); 
  } 
}
const openModal = (id) => byId(id)?.classList.add('show');
const closeModal = (id) => byId(id)?.classList.remove('show');

// =============== UNIQUE ITEM ID GENERATOR ===============
function generateItemId(item) {
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼Î¿Î½Î±Î´Î¹ÎºÎ¿Ï hash Î²Î±ÏƒÎ¹ÏƒÎ¼Î­Î½Î¿ ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬ Ï„Î¿Ï… Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚
    const str = `${item.name}|${item.price}|${JSON.stringify(item.mods)}|${item.isFree}`;
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÏƒÎµ 32-bit integer
    }
    return hash.toString(36);
}
// =============== PRODUCT MERGING ===============
function mergeCartItem(existingItems, newItem) {
    const existingIndex = existingItems.findIndex(item => 
        item.name === newItem.name &&
        item.price === newItem.price &&
        JSON.stringify(item.mods) === JSON.stringify(newItem.mods) &&
        item.isFree === newItem.isFree &&
        !item.isPrinted
    );
    
    if (existingIndex !== -1) {
        existingItems[existingIndex].qty += newItem.qty;
        existingItems[existingIndex].lineTotal = (existingItems[existingIndex].price + existingItems[existingIndex].extra) * existingItems[existingIndex].qty;
        if (existingItems[existingIndex].isFree) existingItems[existingIndex].lineTotal = 0;
        
        showToast(`+${newItem.qty} ${newItem.name} (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¬: ${existingItems[existingIndex].qty})`, 'info', 1500);
        return existingItems;
    } else {
        return [...existingItems, newItem];
    }
}

// =============== REPRINT SYSTEM ===============
function openReprintModal() {
    if (!currentTable) return;
    
    const modalContent = byId('reprintContent');
    const allItems = tables[currentTable].items;
    const printedItems = allItems.filter(item => item.isPrinted);
    
    if (printedItems.length === 0) {
        modalContent.innerHTML = '<div class="empty-cart">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÏ„Ï…Ï€Ï‰Î¼Î­Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>';
    } else {
        let html = '<p>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î± ÎµÎºÏ„Ï…Ï€Ï‰Î¼Î­Î½Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Î³Î¹Î± ÎµÏ€Î±Î½ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·:</p><div style="margin-top: 15px;">';
        
        printedItems.forEach((item, index) => {
            const mods = Object.values(item.mods || {}).join(' â€¢ ');
            const itemId = generateItemId(item); // ÎœÎ¿Î½Î±Î´Î¹ÎºÏŒ ID
            
            html += `
                <div class="reprint-item">
                    <input type="checkbox" class="reprint-checkbox" id="reprint-${itemId}" 
                           data-item-id="${itemId}" checked>
                    <div class="reprint-info">
                        <div><strong>${item.qty} x ${item.name}</strong></div>
                        ${mods ? `<div style="font-size: 12px; color: var(--text-muted);">${mods}</div>` : ''}
                        <div class="reprint-printed">âœ“ Î•ÎºÏ„Ï…Ï€Ï‰Î¼Î­Î½Î¿</div>
                    </div>
                    <div style="font-weight: bold;">${euro(item.lineTotal)}</div>
                </div>
            `;
        });
        
        html += '</div>';
        modalContent.innerHTML = html;
    }
    
    openModal('reprintModal');
}

function setupReprintModal() {
    byId('reprintBtn').addEventListener('click', openReprintModal);
    byId('closeReprint').addEventListener('click', () => closeModal('reprintModal'));
    
    byId('reprintSelected').addEventListener('click', () => {
    const selectedItems = [];
    const allItems = tables[currentTable].items;
    
    qsa('.reprint-checkbox:checked').forEach((checkbox) => {
        const itemId = checkbox.getAttribute('data-item-id');
        // Î’ÏÎµÎ¯Ï„Îµ Ï„Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î¿ ID Ï„Î¿Ï…
        const foundItem = allItems.find(item => 
            generateItemId(item) === itemId && item.isPrinted
        );
        if (foundItem) selectedItems.push(foundItem);
    });
    
    if (selectedItems.length === 0) {
        showToast('Î”ÎµÎ½ ÎµÏ€Î¹Î»Î­Î¾Î±Ï„Îµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±', 'warn');
        return;
    }
    
    printReprint(selectedItems, false);
    closeModal('reprintModal');
});
    
    byId('reprintAll').addEventListener('click', () => {
    const items = tables[currentTable].items.filter(item => item.isPrinted);
    if (items.length === 0) {
        showToast('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÏ„Ï…Ï€Ï‰Î¼Î­Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±', 'warn');
        return;
    }
    
    printReprint(items, true);
    closeModal('reprintModal');
});
}

function printReprint(items, isAll = false) {
    const ts = new Date().toLocaleString('el-GR');
    const deviceName = localStorage.getItem('pos_device_name') || 'ORDER_POS';
    let receiptText = `\n[${deviceName}] [REPRINT] Table ${currentTable}\n${ts}\n--------------------------------\n`;
    
    items.forEach(item => {
        const mods = Object.values(item.mods || {}).join(' | ');
        const freeTag = item.isFree ? ' (FR)' : '';
        receiptText += `${item.qty} x ${item.name}${freeTag}\n`;
        if (mods) receiptText += `  -> ${mods}\n`;
    });
    
    receiptText += '--------------------------------\n';
    receiptText += `Total: ${euro(items.reduce((sum, item) => sum + item.lineTotal, 0))}\n\n`;
    receiptText += `[REPRINT - NOT COUNTED IN TOTAL]\n`;
    
    printViaRawBT(receiptText);
    showToast(`Î•Ï€Î±Î½ÎµÎºÏ„Ï…Ï€ÏÎ¸Î·ÎºÎ±Î½ ${items.length} Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±`, 'success');
}

// =============== CONSTANTS ===============
const CATALOG_STORAGE_KEY = 'pos_catalog_v1';
const TABLES_STORAGE_KEY = 'pos_tables_v1';
const PRINT_COUNTER_KEY = 'pos_print_counter_v1', PRINT_TOTAL_KEY = 'pos_print_total_v1';
const TAKEOUT_COUNT_KEY = 'pos_takeout_count_v1', DISCOUNT_TOTAL_KEY = 'pos_discount_total_v1';
const FREE_COUNT_KEY = 'pos_free_count_v1'; // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: ÎœÎµÏ„ÏÎ·Ï„Î®Ï‚ FREE Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
const CATEGORIES = { coffee: "ÎšÎ±Ï†Î­Î´ÎµÏ‚ / Î¡ÏŒÏ†Î·Î¼Î±", soft: "Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬", juices: "Î§Ï…Î¼Î¿Î¯", drinks: "Î Î¿Ï„Î¬", food: "Î¦Î±Î³Î·Ï„ÏŒ / Î“Î»Ï…ÎºÏŒ" };
const defaultCatalog = {
  coffee: [
    { name: "Espresso", price: 2.50, tag: "coffee" }, { name: "Double Espresso", price: 3.50, tag: "coffee" },  { name: "Freddo Espresso", price: 3.50, tag: "coffee" }, 
    { name: "Cappuccino", price: 3.50, tag: "coffee" }, { name: "Double Cappuccino", price: 4.00, tag: "coffee" }, { name: "Freddo Cappuccino", price: 3.50, tag: "coffee" }, 
    { name: "Ellinikos", price: 2.50, tag: "coffee" }, { name: "Ellinikos (diplos)", price: 3.50, tag: "coffee" }, { name: "Chocolate", price: 4.00, tag: "chocolate" }, 
    { name: "Nescafe", price: 3.50, tag: "coffee" }, { name: "Frappe", price: 3.50, tag: "coffee" }, { name: "Frappe Baileys / pagwto", price: 5.50, tag: "coffee" },
    { name: "Tea", price: 3.00, tag: "tea" }, { name: "Filter", price: 3.50, tag: "coffee" }, { name: "Cacao", price: 3.50, tag: "chocolate" }, 
    { name: "Hotshot", price: 4.00, tag: "coffee" }, { name: "Moccachino", price: 4.50, tag: "coffee" }, { name: "Freddoccino", price: 4.50, tag: "coffee" }, { name: "Milkshake", price: 6.00, tag: "coffee" }    
  ],
  soft: [ 
    { name: "Coca Cola", price: 3.50, tag: "cocacola" },
    { name: "Sprite", price: 3.50, tag: "sprite" },
    { name: "Loux", price: 3.50, tag: "loux" },
    { name: "NERO emf. 0.5L", price: 0.50, tag: "nero" },
    { name: "Anthrakouxo", price: 3.50, tag: "anthrakouxo" },
    { name: "Fraoulada", price: 3.50, tag: "fraoulada" },
    { name: "Ice tea", price: 3.50, tag: "icetea" },
    { name: "Schweppes", price: 3.50, tag: "schweppes" },
    { name: "Spitiki", price: 4.00, tag: "spitiki" },
    { name: "Granita", price: 4.00, tag: "granita" }
  ],
  juices: [ 
    { name: "Fusikos portokali", price: 3.50 }, { name: "Fusikos anamiktos", price: 4.00 }, { name: "Amita Rodakino", price: 3.50 }, 
    { name: "Amita Vussino", price: 3.50 }, { name: "Amita Motion", price: 3.50 }, { name: "Amita Mpanana", price: 3.50 }, 
    { name: "Amita Mpanana - Vussino", price: 3.50 }, { name: "Amita Ananas", price: 3.50 }, { name: "Atomikos xumos", price: 2.00 } 
  ],
  drinks: [ 
    { name: "Alfa", price: 4.00, tag: "drinks" }, { name: "Kaizer", price: 4.00, tag: "drinks" }, { name: "Krasi Leuko", price: 4.00, tag: "drinks" }, 
    { name: "Krasi Rose", price: 4.00, tag: "drinks" }, { name: "Krasi Kokkino", price: 4.00, tag: "drinks" }, { name: "Sangria", price: 4.00, tag: "drinks" }, 
    { name: "Johnie", price: 6.00, tag: "drinks" }, { name: "Haig", price: 6.00, tag: "drinks" }, { name: "Gordon's", price: 6.00, tag: "drinks" }, 
    { name: "Smirnoff", price: 6.00, tag: "drinks" }, { name: "Sercova", price: 6.00, tag: "drinks" }, { name: "Havana", price: 6.00, tag: "drinks" }, 
    { name: "Martini", price: 6.00, tag: "drinks" }, { name: "Baileys", price: 6.00, tag: "drinks" }, { name: "Amarreto", price: 6.00, tag: "drinks" }, 
    { name: "Drambuie", price: 6.00, tag: "drinks" }, { name: "Aperol Spritz", price: 6.00, tag: "drinks" }, { name: "Limoncello Spritz", price: 6.00, tag: "drinks" }, 
    { name: "Ouzo sketo", price: 2.00, tag: "drinks" }, { name: "Ouzo meze", price: 3.50, tag: "drinks" }, { name: "Tsipouro sketo", price: 2.00, tag: "drinks" }, 
    { name: "Tsipouro meze", price: 3.50, tag: "drinks" }, { name: "Koniak", price: 4.00, tag: "drinks" }, { name: "Moctail", price: 5.00, tag: "drinks" }, 
    { name: "Coctail", price: 7.00, tag: "drinks" } 
  ],
  food: [  
    { name: "Tost", price: 3.00, tag: "tost" },
    { name: "Mpagketa", price: 4.00, tag: "mpagketa" },
    { name: "Omeleta", price: 5.50, tag: "omeleta" },
    { name: "Auga Scrambled", price: 6.00 }, 
    { name: "Club Sandwich", price: 6.00 },
    { name: "Tortigia", price: 5.50 },
    { name: "Pancake", price: 4.00, tag: "pancake" },
    { name: "Waffle Sokolata", price: 4.00, tag: "waffle" },
    { name: "Krouasan mini", price: 1.50, tag: "krouasan" },
    { name: "Milopita", price: 4.00, tag: "pita" },
    { name: "Portokalopita", price: 4.00, tag: "pita" },
    { name: "Karudopita", price: 4.00, tag: "pita" },
    { name: "Sokolatopita", price: 4.00, tag: "pita" },
    { name: "Soufle Sokolatas", price: 4.00, tag: "pita" },
    { name: "Pagwto", price: 0, tag: "pagwto" }  
  ]
};

// =============== GLOBAL STATE ===============
let catalog = {}, tables = {};
let currentTable = null, currentTab = 'coffee', currentProduct = null, editingIndex = null;
let isFreeActive = false, selectedItemsForTransfer = [], transferTargetTable = null, editingProductId = null;

// =============== DATA MANAGEMENT ===============
function loadCatalog() {
  catalog = JSON.parse(JSON.stringify(defaultCatalog));
  try {
    const saved = localStorage.getItem(CATALOG_STORAGE_KEY);
    if (saved) {
      const savedCatalog = JSON.parse(saved);
      for (const cat in savedCatalog) {
        if (savedCatalog[cat]) {
          savedCatalog[cat] = savedCatalog[cat].filter(p => p.tag !== 'decaf');
        }
      }
      catalog = savedCatalog;
    }
  } catch(e) {
    console.log("Error loading catalog, using default");
  }
  saveCatalog();
}
function saveCatalog() { localStorage.setItem(CATALOG_STORAGE_KEY, JSON.stringify(catalog)); }
function loadTables() {
  try {
    const saved = localStorage.getItem(TABLES_STORAGE_KEY);
    if (saved) {
      tables = JSON.parse(saved);
      for (let i = 1; i <= 50; i++) if (!tables[i]) tables[i] = { items: [], total: 0, status: 'free', orderNote: '' };
    } else {
      tables = {}; for (let i = 1; i <= 50; i++) tables[i] = { items: [], total: 0, status: 'free', orderNote: '' };
      saveTables();
    }
  } catch (e) {
    tables = {}; for (let i = 1; i <= 50; i++) tables[i] = { items: [], total: 0, status: 'free', orderNote: '' };
    saveTables();
  }
}
function saveTables() { localStorage.setItem(TABLES_STORAGE_KEY, JSON.stringify(tables)); }
function getPrintCounter() { const n = parseInt(localStorage.getItem(PRINT_COUNTER_KEY) || '0'); return isNaN(n) ? 0 : n; }
function setPrintCounter(n) { localStorage.setItem(PRINT_COUNTER_KEY, String(n)); }
function nextPrintNumber() { const cur = getPrintCounter() + 1; setPrintCounter(cur); return cur; }
function getPrintTotal() { const n = parseFloat(localStorage.getItem(PRINT_TOTAL_KEY) || '0'); return isNaN(n) ? 0 : n; }
function setPrintTotal(n) { localStorage.setItem(PRINT_TOTAL_KEY, n.toFixed(2)); }
function addPrintTotal(amount) { setPrintTotal(getPrintTotal() + amount); }
function getTakeoutCount() { const n = parseInt(localStorage.getItem(TAKEOUT_COUNT_KEY) || '0'); return isNaN(n) ? 0 : n; }
function setTakeoutCount(n) { localStorage.setItem(TAKEOUT_COUNT_KEY, String(n)); }
function incrementTakeoutCount() { setTakeoutCount(getTakeoutCount() + 1); }
function getDiscountTotal() { const n = parseFloat(localStorage.getItem(DISCOUNT_TOTAL_KEY) || '0'); return isNaN(n) ? 0 : n; }
function setDiscountTotal(n) { localStorage.setItem(DISCOUNT_TOTAL_KEY, n.toFixed(2)); }
function addDiscountTotal(amount) { setDiscountTotal(getDiscountTotal() + amount); }

// Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Î£Ï…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± FREE Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±
function getFreeCount() { 
  const n = parseInt(localStorage.getItem(FREE_COUNT_KEY) || '0'); 
  return isNaN(n) ? 0 : n; 
}
function setFreeCount(n) { 
  localStorage.setItem(FREE_COUNT_KEY, String(n)); 
}
function addFreeCount(amount) { 
  setFreeCount(getFreeCount() + amount); 
}

// =============== CORE FUNCTIONS ===============
function renderTablesView() {
  const tablesGrid = byId('tablesGrid');
  if (!tablesGrid) return;
  tablesGrid.innerHTML = '';
  const takeawayBtn = document.createElement('button');
  takeawayBtn.className = 'table-btn takeaway';
  takeawayBtn.innerHTML = '<div>Î Î±ÎºÎ­Ï„Î¿</div>';
  takeawayBtn.addEventListener('click', () => openTakeawayModal());
  tablesGrid.appendChild(takeawayBtn);
  Object.keys(tables).map(Number).filter(n => !isNaN(n)).sort((a,b)=>a-b).forEach(num => {
    const t = tables[num];
    const btn = document.createElement('button');
    btn.className = `table-btn ${t.status === 'free' ? 'free' : 'busy'}`;
    btn.innerHTML = `<div>Î¤Ï. ${num}</div><div class="table-total">${euro(t.total)}</div>`;
    btn.addEventListener('click', () => openTable(num));
    tablesGrid.appendChild(btn);
  });
}
function openTable(num) {
  if (!tables[num]) tables[num] = { items: [], total: 0, status: 'free', orderNote: '' };
  currentTable = num;
  byId('tableTitle').textContent = `Î¤ÏÎ±Ï€Î­Î¶Î¹ ${num}`;
  hideEl(byId('tablesView'));
  showEl(byId('orderView'));
  switchTab(currentTab);
  renderCart();
  byId('orderNote').value = tables[currentTable].orderNote || '';
  tables[currentTable].status === 'busy' ? showEl(byId('transferTable')) : hideEl(byId('transferTable'));
}
function switchTab(tabKey) {
  currentTab = tabKey;
  renderProducts(tabKey);
  currentProduct = editingIndex = null;
}
function renderProducts(tabKey) {
  const productsEl = byId('products');
  const list = catalog[tabKey] || [];
  productsEl.innerHTML = '';
  list.forEach((p) => {
    const item = document.createElement('div');
    item.className = `product ${p.tag === 'decaf' ? 'decaf' : ''}`;
    item.innerHTML = `<div class="product-title">${p.name}</div><div class="product-price">${euro(p.price)}</div>`;
    item.addEventListener('click', () => {
      qsa('.product').forEach(p => p.classList.remove('active'));
      item.classList.add('active');
      openModifiersPopup(p);
    });
    productsEl.appendChild(item);
  });
}
function renderCart() {
  if (!currentTable) return;
  const t = tables[currentTable], ul = byId('cartList');
  ul.innerHTML = '';
  if (t.items.length === 0) {
    ul.innerHTML = '<div class="empty-cart">Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿</div>';
    byId('cartTotal').textContent = '0.00â‚¬';
    updateCartBadge();
    return;
  }
  t.items.forEach((it, i) => {
    const li = document.createElement('li');
    li.className = `cart-item ${it.isPrinted ? 'printed' : ''}`;
    const mods = Object.values(it.mods || {}).join(' â€¢ ');
    const lineTotal = it.isFree ? 'FREE' : euro(it.lineTotal);
    li.innerHTML = `<div><div><strong>${it.qty} x ${it.name}</strong></div>${mods ? `<div class="meta">${mods}</div>` : ''}</div>
      <div class="actions">
        <div style="font-weight:bold; color: ${it.isFree ? 'var(--success)' : ''};">${lineTotal}</div>
        <button class="btn remove" data-index="${i}">âœ•</button>
        ${!it.isPrinted ? `<button class="btn edit-item" data-index="${i}">âœ</button>` : ''}
      </div>`;
    li.querySelector('.remove').addEventListener('click', (e) => { e.stopPropagation(); removeCartItem(i); });
    const editBtn = li.querySelector('.edit-item');
    if (editBtn) editBtn.addEventListener('click', (e) => { e.stopPropagation(); editCartItem(i); });
    ul.appendChild(li);
  });
  byId('cartTotal').textContent = euro(t.total);
  updateCartBadge();
}
function updateCartBadge() {
  if (!currentTable) { 
    hideEl(byId('cartBadge')); 
    return; 
  }
  
  const unprintedItems = tables[currentTable].items.filter(it => !it.isPrinted);
  const totalItemCount = unprintedItems.reduce((total, item) => total + item.qty, 0);
  const badge = byId('cartBadge');
  
  if (totalItemCount > 0) {
    badge.textContent = totalItemCount;
    showEl(badge);
  } else {
    hideEl(badge);
  }
}
function calcTotal(items) { return items.reduce((sum, item) => sum + (item.lineTotal || 0), 0); }

// =============== FOOD MODIFIERS ===============
function tostModifiers() {
  return `<div class="block cat-4">
    <h4>Tost(3.00â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ Î¤ÏÏ€Î¿Ï‚</div>
      <div class="chips" data-key="tostType" data-single="true">
        <button class="chip" data-price="0">Aplo (leuko)</button>
        <button class="chip" data-price="0.50">Olikhs (+0.50â‚¬)</button>
        <button class="chip" data-price="1.00">Special (+1.00â‚¬)</button>
      </div>
    </div>
    <div class="row">
      <div class="category-title">ğŸ§€ Î£Ï…ÏƒÏ„Î±Ï„Î¹ÎºÎ¬</div>
      <div class="chips" data-key="tostExtras" data-single="false">
        <button class="chip">Turi</button>
        <button class="chip">Diplo Turi</button>
        <button class="chip">Galopoula</button>
        <button class="chip">Pariza</button>
      </div>
    </div>
  </div>`;
}
function mpagketaModifiers() {
  return `<div class="block cat-4">
    <h4>ÎœÏ€Î±Î³ÎºÎ­Ï„Î± (4.00â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ¥– Î¤ÏÏ€Î¿Ï‚</div>
      <div class="chips" data-key="mpagketaType" data-single="true">
        <button class="chip">LEYKH</button>
        <button class="chip">MAYRH</button>
      </div>
    </div>
  </div>`;
}
function omeletaModifiers() {
  return `<div class="block cat-4">
    <h4>OMELETA (5.50â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ¥š Î•Ï€Î¹Ï€Î»Î­Î¿Î½</div>
      <div class="chips" data-key="omeletaExtras" data-single="false">
        <button class="chip" data-price="1.50">Sandwich (+1.50â‚¬)</button>
        <button class="chip" data-price="1.00">Turi (+1.00â‚¬)</button>
      </div>
    </div>
  </div>`;
}
function krouasanModifiers() {
  return `<div class="block cat-4">
    <h4>Krouasan Mini (1.50â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ¥ Î“Î­Î¼Î¹ÏƒÎ·</div>
      <div class="chips" data-key="krouasanType" data-single="true">
        <button class="chip" data-price="0">Vouturou</button>
        <button class="chip" data-price="0.50">Sokolata (+0.50â‚¬)</button>
      </div>
    </div>
  </div>`;
}
function pitaModifiers() {
  return `<div class="block cat-4">
    <h4>Î Î¯Ï„Î± (4.00â‚¬)</h4>
    <div class="row">
      <div class="category-title">â• Î•Ï€Î¹Ï€Î»Î­Î¿Î½</div>
      <div class="chips" data-key="pitaExtra" data-single="false">
        <button class="chip" data-price="2.00">Pagwto (+2.00â‚¬)</button>
      </div>
    </div>
  </div>`;
}
function pancakeModifiers() {
  return `<div class="block cat-4">
    <h4>Pancake (4.00â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ« Î’Î±ÏƒÎ¹ÎºÎ® Î“ÎµÏÏƒÎ·</div>
      <div class="chips" data-key="pancakeBase" data-single="true">
        <button class="chip">Sokolata</button>
        <button class="chip">Meli</button>
      </div>
    </div>
    <div class="row">
      <div class="category-title">â• Î•Ï€Î¹Ï€Î»Î­Î¿Î½ (+0.50â‚¬ Î­ÎºÎ±ÏƒÏ„Î¿)</div>
      <div class="chips" data-key="pancakeExtras" data-single="false">
        <button class="chip" data-price="0.50">Mpanana</button>
        <button class="chip" data-price="0.50">Mpiskoto</button>
        <button class="chip" data-price="0.50">Mhlo</button>
        <button class="chip" data-price="0.50">Xiroi Karpoi</button>
        <button class="chip">Kanela</button>
      </div>
    </div>
  </div>`;
}
function waffleModifiers() {
  return `<div class="block cat-4">
    <h4>Waffle Sokolata (4.00â‚¬)</h4>
    <div class="row">
      <div class="category-title">â• Î•Ï€Î¹Ï€Î»Î­Î¿Î½</div>
      <div class="chips" data-key="waffleExtras" data-single="false">
        <button class="chip" data-price="0.50">mpiskoto (+0.50â‚¬)</button>
        <button class="chip" data-price="0.50">mpanana (+0.50â‚¬)</button>
      </div>
    </div>
  </div>`;
}
function pagwtoModifiers() {
  return `<div class="block cat-4">
    <h4>Î Î±Î³Ï‰Ï„ÏŒ</h4>
    <div class="row">
      <div class="category-title">ğŸ¨ ÎœÏ€Î¬Î»ÎµÏ‚</div>
      <div class="chips" data-key="scoops" data-single="true">
        <button class="chip" data-price="2.00">1 mpala (+2.00â‚¬)</button>
        <button class="chip" data-price="4.00">2 mpales (+4.00â‚¬)</button>
        <button class="chip" data-price="6.00">3 mpales (+6.00â‚¬)</button>
      </div>
    </div>
    <div class="row">
      <div class="category-title flavor">ğŸ¦ Î“ÎµÏÏƒÎµÎ¹Ï‚</div>
      <div class="chips" data-key="iceFlavor" data-single="false">
        <button class="chip">Fraoula</button><button class="chip">Mpanana</button><button class="chip">Fistiki</button>
        <button class="chip">Krema</button><button class="chip">Sokolata</button><button class="chip">Cookies</button>
        <button class="chip">Parfe Krema</button><button class="chip">Parfe Sokolata</button>
      </div>
    </div>
    <div class="row">
      <div class="category-title flavor">ğŸ¯ Î£Î¹ÏÏŒÏ€Î¹</div>
      <div class="chips" data-key="iceSyrup" data-single="false">
        <button class="chip">Vussino</button><button class="chip">Karamela</button><button class="chip">Sokolata</button>
      </div>
    </div>
  </div>`;
}
function foodModifiers(product) {
  if (product.tag === 'tost') return tostModifiers();
  if (product.tag === 'mpagketa') return mpagketaModifiers();
  if (product.tag === 'omeleta') return omeletaModifiers();
  if (product.tag === 'krouasan') return krouasanModifiers();
  if (product.tag === 'pita') return pitaModifiers();
  if (product.tag === 'pancake') return pancakeModifiers();
  if (product.tag === 'waffle') return waffleModifiers();
  if (product.tag === 'pagwto') return pagwtoModifiers();
  return '';
}

// =============== SOFT DRINKS MODIFIERS ===============
function cocacolaModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>Coca Cola (3.50â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ¥¤ Î•Î¯Î´Î¿Ï‚</div>
      <div class="chips" data-key="cocacolaType" data-single="true">
        <button class="chip">Zero</button>
      </div>
    </div>
  </div>`;
}
function spriteModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>Sprite (3.50â‚¬)</h4>
  </div>`;
}
function louxModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>Loux (3.50â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ¹ Î“ÎµÏÏƒÎ·</div>
      <div class="chips" data-key="louxFlavor" data-single="true">
        <button class="chip">Porokalada</button>
        <button class="chip">Lemonada</button>
        <button class="chip">Vussinada</button>
      </div>
    </div>
  </div>`;
}
function neroModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>NERO emf. 0.5L (0.50â‚¬)</h4>
  </div>`;
}
function anthrakouxoModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>Anthrakouxo (3.50â‚¬)</h4>   
  </div>`;
}
function fraouladaModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>Fraoulada (3.50â‚¬)</h4>
  </div>`;
}
function iceteaModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>Ice tea (3.50â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸµ Î“ÎµÏÏƒÎ·</div>
      <div class="chips" data-key="iceteaFlavor" data-single="true">
        <button class="chip">Lemon</button>
        <button class="chip">Rodakino</button>
        <button class="chip">GREEN NO sugar</button>
      </div>
    </div>
  </div>`;
}
function schweppesModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>Schweppes (3.50â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ¥¤ Î“ÎµÏÏƒÎ·</div>
      <div class="chips" data-key="schweppesFlavor" data-single="true">
        <button class="chip">Rodi</button>
        <button class="chip">Portokali</button>
        <button class="chip">Grapefruit</button>
        <button class="chip">Lemon</button>
        <button class="chip">Peragamonto</button>
      </div>
    </div>
  </div>`;
}
function spitikiModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>Spitiki (4.00â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ¹ Î“ÎµÏÏƒÎ·</div>
      <div class="chips" data-key="spitikiFlavor" data-single="true">
        <button class="chip">Lemonada</button>
        <button class="chip">Vussinada</button>
      </div>
    </div>
  </div>`;
}
function granitaModifiers() {
  return `<div class="block cat-2" style="margin-top: 15px;">
    <h4>Granita (4.00â‚¬)</h4>
    <div class="row">
      <div class="category-title">ğŸ§ Î“ÎµÏÏƒÎ·</div>
      <div class="chips" data-key="granitaFlavor" data-single="true">
        <button class="chip">Fraoula</button>
        <button class="chip">Lemoni</button>
      </div>
    </div>
  </div>`;
}
function softModifiers(product) {
  if (product.tag === 'cocacola') return cocacolaModifiers();
  if (product.tag === 'sprite') return spriteModifiers();
  if (product.tag === 'loux') return louxModifiers();
  if (product.tag === 'nero') return neroModifiers();
  if (product.tag === 'anthrakouxo') return anthrakouxoModifiers();
  if (product.tag === 'fraoulada') return fraouladaModifiers();
  if (product.tag === 'icetea') return iceteaModifiers();
  if (product.tag === 'schweppes') return schweppesModifiers();
  if (product.tag === 'spitiki') return spitikiModifiers();
  if (product.tag === 'granita') return granitaModifiers();
  return '';
}

// =============== MODIFIERS MODAL ===============
function openModifiersPopup(product, isEditing = false) {
  currentProduct = product;
  editingIndex = isEditing ? editingIndex : null;
  isFreeActive = false;
  const modalContent = byId('modifiersModalContent');
  modalContent.innerHTML = createModifiersContent(product);
  byId('modifiersModalTitle').textContent = `Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹ Î³Î¹Î± ${product.name}`;
  setTimeout(() => {
    const addBtn = byId('modalAddToCart');
    if (addBtn) addBtn.textContent = isEditing ? 'Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎšÎ±Î»Î±Î¸Î¹Î¿Ï' : 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿ ÎšÎ±Î»Î¬Î¸Î¹';
  }, 50);
  openModal('modifiersModal');
  setTimeout(() => setupModifiersModalListeners(product, isEditing), 50);
}
function createModifiersContent(product) {
  const isCoffee = ['coffee','decaf','chocolate','tea'].includes(product.tag);
  const isDrink = product.tag === 'drinks', isIce = product.tag === 'ice';
  const isFood = ['tost','mpagketa','omeleta','krouasan','pita','pancake','waffle','pagwto'].includes(product.tag);
  const isSoft = ['cocacola','sprite','loux','nero','anthrakouxo','fraoulada','icetea','schweppes','spitiki','granita'].includes(product.tag);
  
  let content = `<div class="modifiers-content">
    <h4 style="margin-top: 0; margin-bottom: 20px; color: var(--accent-yellow);">${product.name} - ${euro(product.price)}</h4>
    <button class="btn free-inactive" id="modalMarkAsFree">FREE</button>
    <div class="qty-control">
      <label style="color: var(--accent-yellow);">Î Î¿ÏƒÏŒÏ„Î·Ï„Î±:</label>
      <button class="btn" id="modalQtyMinus">-</button>
      <input id="modalQtyInput" min="1" type="number" value="1" style="width: 70px; padding: 12px; font-size: 20px;">
      <button class="btn" id="modalQtyPlus">+</button>
    </div>`;
  
  if (product.tag === 'chocolate') content += chocolateModifiers();
  if (product.tag === 'tea') content += teaModifiers();
  if (isCoffee && product.tag !== 'chocolate') content += coffeeModifiers();
  if (isDrink) content += drinkModifiers();
  if (isFood) content += foodModifiers(product);
  if (isSoft) content += softModifiers(product);
  
  content += `<div style="margin: 20px 0;"><label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚:</label>
    <textarea id="modalProductNote" placeholder="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚" rows="2" style="width: 100%;"></textarea>
  </div></div>`;
  return content;
}
function chocolateModifiers() {
  return `<div class="block cat-1" style="margin-top: 15px;">
    <h4>Î£Î¿ÎºÎ¿Î»Î¬Ï„Î±</h4>
    <div class="two-columns-mobile">
      <div class="modifiers-column">
        <div class="row">
          <div class="category-title" style="font-size:13px;">ğŸŒ¡ï¸ Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±</div>
          <div class="chips" data-key="chocolateTemp" data-single="true">
            <button class="chip">HOT</button>
            <button class="chip">COLD</button>
          </div>
        </div>
      </div>
      <div class="modifiers-column">
        <div class="row">
          <div class="category-title" style="font-size:13px;">ğŸ« Î“ÎµÏÏƒÎ·</div>
          <div class="chips" data-key="chocoFlavor" data-single="false">
            <button class="chip">aplh</button>
            <button class="chip">leukh</button>
            <button class="chip">Lacta</button>
            <button class="chip">Fystiki</button>
            <button class="chip">Protein</button>
            <button class="chip">Caramela</button>
            <button class="chip">Kiss</button>
            <button class="chip">Bueno</button>
            <button class="chip">Oreo</button>
            <button class="chip">Snickers</button>
          </div>
        </div>
      </div>
    </div>
    <div style="margin-top:10px;">
      <div class="checkbox-row"><label><input id="modalAddCream" type="checkbox"><span style="font-size:13px;">+Krema (+0.50â‚¬)</span></label></div>
      <div class="checkbox-row"><label><input id="modalAlmondMilk" type="checkbox"><span style="font-size:13px;">+Gala amygdalou (+0.50â‚¬)</span></label></div>
      <div class="checkbox-row"><label><input id="modalWhipped" type="checkbox"><span style="font-size:13px;">+Santigy (+0.50â‚¬)</span></label></div>
      <div class="checkbox-row"><label><input id="modalAddSyrup" type="checkbox"><span style="font-size:13px;">+Siropi geusis (+0.50â‚¬)</span></label></div>
    </div>
  </div>`;
}
function teaModifiers() {
  return `<div class="block cat-1" style="margin-top: 20px;">
    <h4>Î¤ÏƒÎ¬Î¹</h4>
    <div class="row">
      <div class="category-title flavor">ğŸµ Î“ÎµÏÏƒÎµÎ¹Ï‚</div>
      <div class="chips" data-key="teaFlavor" data-single="true">
        <button class="chip">Aplo</button><button class="chip">Prasino</button><button class="chip">Lemoni</button>
        <button class="chip">Vanilia Karamela</button><button class="chip">Passion fruit</button>
        <button class="chip">milo kanela</button><button class="chip">tou vounou</button>
        <button class="chip">tropika frouta</button><button class="chip">portokali</button><button class="chip">Xamomili</button>
      </div>
    </div>
  </div>`;
}
function coffeeModifiers() {
  return `<div class="block cat-1" style="margin-top: 15px;">
    <h4>ÎšÎ±Ï†Î­Ï‚ / Î¡ÏŒÏ†Î·Î¼Î±</h4>
    <div class="two-columns-mobile">
      <div class="modifiers-column">
        <div class="row">
          <div class="category-title" style="font-size:13px;">ğŸ“Š Î Î¿ÏƒÏŒÏ„.Î–Î¬Ï‡Î±ÏÎ·Ï‚</div>
          <div class="chips" data-key="sugarLevel" data-single="true">
            <button class="chip">sketo</button>          
           <button class="chip">ligh</button>
            <button class="chip">metrio</button>
            <button class="chip">pros gluko</button>
            <button class="chip">gluko</button>
            <button class="chip">poly gluko</button>
          </div>
        </div>
        <div class="row">
          <div class="category-title" style="font-size:13px;">ğŸ¥› Î Î¿ÏƒÏŒÏ„.Î“Î¬Î»Î±Ï„Î¿Ï‚</div>
          <div class="chips" data-key="milkAmount" data-single="true">
            <button class="chip">ligo gala</button>
            <button class="chip">gala</button>
            <button class="chip">poly gala</button>
          </div>
        </div>
        <div class="row">
          <div class="category-title" style="font-size:13px;">âœ¨ Î“Î±ÏÎ½Î¯ÏÎ¹ÏƒÎ¼Î±</div>
          <div class="chips" data-key="garnish" data-single="true">
            <button class="chip">KANELA</button>
            <button class="chip">SOKOLATA</button>
          </div>
        </div>
      </div>
      <div class="modifiers-column">
        <div class="row">
          <div class="category-title" style="font-size:13px;">ğŸ¬ Î•Î¯Î´Î¿Ï‚ Î–Î¬Ï‡Î±ÏÎ·Ï‚</div>
          <div class="chips" data-key="sugarType" data-single="true">
            <button class="chip">leukh</button>
            <button class="chip">maurh</button>
            <button class="chip">stevia</button>
            <button class="chip">zaxarinh</button>
            <button class="chip">meli</button>
          </div>
        </div>
        <div class="row">
          <div class="category-title" style="font-size:13px;">âš¡ Î’Î±ÏÏÏ„Î·Ï„Î±</div>
          <div class="chips" data-key="coffeeStrength" data-single="true">
            <button class="chip">elafrys</button>
            <button class="chip">varys</button>
            <button class="chip">Stretto</button>
            <button class="chip">Lugo</button>
            <button class="chip">Latte</button>
            <button class="chip">Americano</button>
            <button class="chip">Macchiato</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="category-title" style="font-size:13px;">ğŸŒ± Î•Î¯Î´Î¿Ï‚</div>
      <div class="chips" data-key="coffeeType" data-single="true">
        <button class="chip">DECAF</button>
      </div>
    </div>
    <div style="margin-top:10px;">
      <div class="checkbox-row"><label><input id="modalAddCream" type="checkbox"><span style="font-size:13px;">+Krema (+0.50â‚¬)</span></label></div>
      <div class="checkbox-row"><label><input id="modalAlmondMilk" type="checkbox"><span style="font-size:13px;">+Gala amygdalou (+0.50â‚¬)</span></label></div>
      <div class="checkbox-row"><label><input id="modalWhipped" type="checkbox"><span style="font-size:13px;">+Santigy (+0.50â‚¬)</span></label></div>
      <div class="checkbox-row"><label><input id="modalAddSyrup" type="checkbox"><span style="font-size:13px;">+Siropi geusis (+0.50â‚¬)</span></label></div>
    </div>
  </div>`;
}
function drinkModifiers() {
  return `<div class="block cat-1" style="margin-top: 20px;"><h4>Î Î¿Ï„ÏŒ</h4>
    <div class="row">
      <div class="category-title flavor">ğŸ¥¤ Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÏŒ</div>
      <div class="chips" data-key="mixerSoft" data-single="true">
        <button class="chip">Coca Cola</button><button class="chip">Sprite</button><button class="chip">Soda</button>
        <button class="chip">Tonic</button><button class="chip">Grapefruit</button>
      </div>
    </div>
    <div class="row">
      <div class="category-title flavor">ğŸ§ƒ Î§Ï…Î¼ÏŒÏ‚</div>
      <div class="chips" data-key="mixerJuice" data-single="true">
        <button class="chip">lemoni</button><button class="chip">portokali</button><button class="chip">vussino</button>
      </div>
    </div>
    <div class="row">
      <div class="category-title">ğŸ· Î Î¿Ï„Î®ÏÎ¹</div>
      <div class="chips" data-key="glass" data-single="true">
        <button class="chip">psilo</button><button class="chip">konto</button>
      </div>
    </div>
    <div class="row">
      <div class="category-title">ğŸ§Š Î Î¬Î³Î¿Ï‚</div>
      <div class="chips" data-key="ice" data-single="true">
        <button class="chip">me pago</button><button class="chip">xwris pago</button><button class="chip">poly pago</button>
        <button class="chip">ligo pago</button>
      </div>
    </div>        
    <div class="row">
      <div class="category-title" style="font-size:13px;">âœ¨ Î“Î±ÏÎ½Î¯ÏÎ¹ÏƒÎ¼Î±</div>
      <div class="chips" data-key="garnish" data-single="true">
        <button class="chip">feta lemoni</button>
        <button class="chip">feta portokali</button>
      </div>
    </div>
  </div>`;
}

function setupModifiersModalListeners(product, isEditing) {
  const qtyInput = byId('modalQtyInput'), qtyPlus = byId('modalQtyPlus'), qtyMinus = byId('modalQtyMinus');
  const addBtn = byId('modalAddToCart'), freeBtn = byId('modalMarkAsFree');
  if (qtyPlus) qtyPlus.addEventListener('click', () => qtyInput.value = parseInt(qtyInput.value) + 1);
  if (qtyMinus) qtyMinus.addEventListener('click', () => { if (qtyInput.value > 1) qtyInput.value = parseInt(qtyInput.value) - 1; });
  if (addBtn) {
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => isEditing ? updateCartItemFromModal() : addProductToCartFromModal());
  }
  if (freeBtn) {
    freeBtn.addEventListener('click', function() {
        isFreeActive = !isFreeActive;
        if (isFreeActive) {
            this.style.background = 'var(--success)';
            this.style.color = 'white';
            this.style.borderColor = 'var(--success)';
        } else {
            this.style.background = 'transparent';
            this.style.color = 'var(--success)';
            this.style.borderColor = 'var(--success)';
        }
    });
  }
  qsa('#modifiersModalContent .chips[data-key]').forEach(group => {
    const isSingle = group.dataset.single === 'true';
    group.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip');
      if (!btn) return;
      if (isSingle) {
        if (btn.classList.contains('active')) btn.classList.remove('active');
        else { qsa('.chip', group).forEach(chip => chip.classList.remove('active')); btn.classList.add('active'); }
      } else btn.classList.toggle('active');
    });
  });
}
function addProductToCartFromModal() {
  if (!currentTable || !currentProduct) { 
    showToast('Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ Ï„ÏÎ±Ï€Î­Î¶Î¹/Ï€ÏÏŒÏŠÎ¿Î½', 'warn'); 
    closeModal('modifiersModal'); 
    return; 
  }
  
  const quantity = parseInt(byId('modalQtyInput').value) || 1;
  const note = byId('modalProductNote')?.value.trim() || '';
  const item = { name: currentProduct.name, price: currentProduct.price, qty: quantity, mods: {}, extra: 0, tag: currentProduct.tag, isPrinted: false, isFree: isFreeActive, lineTotal: 0 };
  if (note) item.mods.note = note;
  
  let extraPrice = 0;
  
  qsa('#modifiersModalContent .chips[data-key]').forEach(group => {
    const key = group.dataset.key;
    const activeChips = Array.from(group.querySelectorAll('.chip.active')).map(c => {
      const chipText = c.textContent.trim();
      const priceAttr = c.getAttribute('data-price');
      if (priceAttr) extraPrice += parseFloat(priceAttr) || 0;
      return chipText;
    }).filter(t => t);
    
    if (activeChips.length > 0) item.mods[key] = activeChips.join(', ');
  });
  
  const coffeeTypeChips = Array.from(qsa('#modifiersModalContent .chips[data-key="coffeeType"] .chip.active')).map(c => c.textContent.trim());
  if (coffeeTypeChips.includes('DECAF')) {
    item.mods.coffeeType = 'DECAF';
  }
  
  if (['coffee','decaf','chocolate','tea'].includes(item.tag)) {
    const checkboxes = { 'modalWhipped':'+Santigi (+0.50â‚¬)','modalAddCream':'+Krema (+0.50â‚¬)','modalAlmondMilk':'+Gala amygdalou (+0.50â‚¬)','modalAddSyrup':'+Siropi (+0.50â‚¬)' };
    Object.keys(checkboxes).forEach(id => {
      const cb = byId(id); if (cb && cb.checked) { item.mods[id.replace('modal','').toLowerCase()] = checkboxes[id]; extraPrice += 0.50; }
    });
  }
  
  item.extra += extraPrice;
  item.lineTotal = (item.price + item.extra) * item.qty;
  if (item.isFree) item.lineTotal = 0;
  
  // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: ÎšÎ±Ï„Î±Î¼Î­Ï„ÏÎ·ÏƒÎ· FREE Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
  if (item.isFree) {
    addFreeCount(quantity);
  }
  
  const merged = mergeCartItem(tables[currentTable].items, item);
  tables[currentTable].items = merged;
  tables[currentTable].total = calcTotal(tables[currentTable].items);
  tables[currentTable].status = 'busy';
  saveTables();
  renderCart();
  updateCartBadge();
  showToast(`${quantity}x ${item.name} Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹`, 'success', 2000);
  closeModal('modifiersModal');
  
  // Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î·Î½ Ï€ÏÏÏ„Î· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± (coffee)
  currentTab = 'coffee';
  renderProducts('coffee');
  qsa('.tab').forEach(b => b.classList.remove('active'));
  qsa(`.tab[data-tab="coffee"]`).forEach(b => b.classList.add('active'));
  setTimeout(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 100);
}
function updateCartItemFromModal() {
  if (!currentTable || !currentProduct || editingIndex === null) return;
  const quantity = parseInt(byId('modalQtyInput').value) || 1;
  const note = byId('modalProductNote')?.value.trim() || '';
  const oldItem = tables[currentTable].items[editingIndex];
  const updatedItem = { name: currentProduct.name, price: currentProduct.price, qty: quantity, mods: {}, extra: 0, tag: currentProduct.tag, isPrinted: oldItem.isPrinted, isFree: isFreeActive, lineTotal: 0 };
  if (note) updatedItem.mods.note = note;
  
  let extraPrice = 0;
  
  qsa('#modifiersModalContent .chips[data-key]').forEach(group => {
    const key = group.dataset.key;
    const activeChips = Array.from(group.querySelectorAll('.chip.active')).map(c => {
      const chipText = c.textContent.trim();
      const priceAttr = c.getAttribute('data-price');
      if (priceAttr) extraPrice += parseFloat(priceAttr) || 0;
      return chipText;
    }).filter(t => t);
    
    if (activeChips.length > 0) updatedItem.mods[key] = activeChips.join(', ');
  });
  
  const coffeeTypeChips = Array.from(qsa('#modifiersModalContent .chips[data-key="coffeeType"] .chip.active')).map(c => c.textContent.trim());
  if (coffeeTypeChips.includes('DECAF')) {
    updatedItem.mods.coffeeType = 'DECAF';
  }
  
  if (['coffee','decaf','chocolate','tea'].includes(updatedItem.tag)) {
    const checkboxes = { 'modalWhipped':'+Santigi (+0.50â‚¬)','modalAddCream':'+Krema (+0.50â‚¬)','modalAlmondMilk':'+Gala amygdalou (+0.50â‚¬)','modalAddSyrup':'+Siropi (+0.50â‚¬)' };
    Object.keys(checkboxes).forEach(id => {
      const cb = byId(id); if (cb && cb.checked) { updatedItem.mods[id.replace('modal','').toLowerCase()] = checkboxes[id]; extraPrice += 0.50; }
    });
  }
  
  updatedItem.extra += extraPrice;
  updatedItem.lineTotal = (updatedItem.price + updatedItem.extra) * updatedItem.qty;
  if (updatedItem.isFree) updatedItem.lineTotal = 0;
  
  // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎºÎ±Ï„Î±Î¼Î­Ï„ÏÎ·ÏƒÎ·Ï‚ FREE Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
  if (oldItem.isFree && !updatedItem.isFree) {
    addFreeCount(-oldItem.qty);
  } else if (!oldItem.isFree && updatedItem.isFree) {
    addFreeCount(updatedItem.qty);
  } else if (oldItem.isFree && updatedItem.isFree && oldItem.qty !== updatedItem.qty) {
    addFreeCount(updatedItem.qty - oldItem.qty);
  }
  
  tables[currentTable].items[editingIndex] = updatedItem;
  tables[currentTable].total = calcTotal(tables[currentTable].items);
  tables[currentTable].status = tables[currentTable].items.length > 0 ? 'busy' : 'free';
  saveTables();
  renderCart();
  updateCartBadge();
  showToast(`${updatedItem.qty}x ${updatedItem.name} ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹`, 'success', 2000);
  closeModal('modifiersModal');
  
  // Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î·Î½ Ï€ÏÏÏ„Î· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± (coffee)
  currentTab = 'coffee';
  renderProducts('coffee');
  qsa('.tab').forEach(b => b.classList.remove('active'));
  qsa(`.tab[data-tab="coffee"]`).forEach(b => b.classList.add('active'));
  setTimeout(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 100);
}

// =============== CART OPERATIONS ===============
function removeCartItem(index) {
  if (!currentTable) return;
  const item = tables[currentTable].items[index];
  if (item.isPrinted && !confirm(`Î‘Ï…Ï„ÏŒ Ï„Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ Î­Ï‡ÎµÎ¹ Î®Î´Î· ÎµÎºÏ„Ï…Ï€Ï‰Î¸ÎµÎ¯.\n\nÎ— Î±Ï†Î±Î¯ÏÎµÏƒÎ® Ï„Î¿Ï… Î¸Î± Î´Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹ Ï„Î¿ ÏƒÏÎ½Î¿Î»Î¿ Ï„Î¿Ï… Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï, Î±Î»Î»Î¬ Î´ÎµÎ½ Î¸Î± Î±Î»Î»Î¬Î¾ÎµÎ¹ Ï„Î¿Î½ ÏƒÏ…Î½Î¿Î»Î¹ÎºÏŒ Ï„Î¶Î¯ÏÎ¿ Ï„Î·Ï‚ Î²Î¬ÏÎ´Î¹Î±Ï‚.\n\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ Î¼Îµ Ï„Î·Î½ Î±Ï†Î±Î¯ÏÎµÏƒÎ·;`)) return;
  if (item.qty > 1) {
    item.qty -= 1;
    item.lineTotal = (item.price + item.extra) * item.qty;
    if (item.isFree) item.lineTotal = 0;
    
    // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: ÎœÎµÎ¯Ï‰ÏƒÎ· Î¼ÎµÏ„ÏÎ·Ï„Î® FREE Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
    if (item.isFree) {
      addFreeCount(-1);
    }
  } else {
    // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: ÎœÎµÎ¯Ï‰ÏƒÎ· Î¼ÎµÏ„ÏÎ·Ï„Î® FREE Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
    if (item.isFree) {
      addFreeCount(-item.qty);
    }
    tables[currentTable].items.splice(index, 1);
  }
  tables[currentTable].total = calcTotal(tables[currentTable].items);
  tables[currentTable].status = tables[currentTable].items.length > 0 ? 'busy' : 'free';
  saveTables();
  renderCart(); renderTablesView();
  showToast('Î¤Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ Î±Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎµ', 'info');
}
function editCartItem(index) {
  const item = tables[currentTable].items[index];
  if (item.isPrinted) return;
  for (const cat in catalog) {
    const product = catalog[cat].find(p => p.name === item.name);
    if (product) {
      currentProduct = product;
      editingIndex = index;
      isFreeActive = item.isFree || false;
      openModifiersPopup(product, true);
      setTimeout(() => {
        byId('modalQtyInput').value = item.qty;
        byId('modalProductNote').value = item.mods.note || '';
        const freeBtn = byId('modalMarkAsFree');
        if (item.isFree) { freeBtn.classList.remove('free-inactive'); freeBtn.classList.add('free-active'); freeBtn.textContent = 'FREE (Î•Î½ÎµÏÎ³ÏŒ)'; }
        else { freeBtn.classList.remove('free-active'); freeBtn.classList.add('free-inactive'); freeBtn.textContent = 'FREE'; }
        qsa('#modifiersModalContent .chips[data-key]').forEach(group => {
          const key = group.dataset.key;
          if (item.mods[key]) {
            const values = item.mods[key].split(',').map(v => v.trim());
            group.querySelectorAll('.chip').forEach(chip => { 
              if (values.includes(chip.textContent.trim())) chip.classList.add('active'); 
              const priceAttr = chip.getAttribute('data-price');
              if (priceAttr && item.mods[key].includes(chip.textContent.trim())) chip.classList.add('active');
            });
          }
        });
        if (['coffee','decaf','chocolate','tea'].includes(item.tag)) {
          const checkboxes = { 'whipped':'modalWhipped','cream':'modalAddCream','almondMilk':'modalAlmondMilk','addSyrup':'modalAddSyrup' };
          Object.keys(checkboxes).forEach(key => { if (item.mods[key]) { const cb = byId(checkboxes[key]); if (cb) cb.checked = true; } });
        }
      }, 100);
      break;
    }
  }
}
function clearDraft() {
  if (!currentTable) return;
  tables[currentTable].items = tables[currentTable].items.filter(item => item.isPrinted);
  tables[currentTable].total = calcTotal(tables[currentTable].items);
  tables[currentTable].status = tables[currentTable].items.length > 0 ? 'busy' : 'free';
  saveTables(); renderCart();
  showToast('Î¤Î± Î¼Î· ÎµÎºÏ„Ï…Ï€Ï‰Î¼Î­Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½', 'info');
}
function closeTable() {
  if (!currentTable || !confirm("Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± ÎºÎ»ÎµÎ¯ÏƒÎµÏ„Îµ Ï„Î¿ Ï„ÏÎ±Ï€Î­Î¶Î¹;")) return;
  tables[currentTable] = { items: [], total: 0, status: 'free', orderNote: '' };
  byId('orderNote').value = '';
  saveTables(); renderTablesView(); goBackToTables();
  showToast('Î¤Î¿ Ï„ÏÎ±Ï€Î­Î¶Î¹ Î­ÎºÎ»ÎµÎ¹ÏƒÎµ', 'success');
}

// =============== PRINTING ===============
function printViaRawBT(text) {
  const base64String = btoa(unescape(encodeURIComponent(text)));
  const url = `rawbt:base64,${base64String}`;
  window.location.href = url;
}
function executeAndPrint() {
  if (!currentTable) return;
  const t = tables[currentTable];
  const itemsToPrint = t.items.filter(it => !it.isPrinted);
  const orderNote = t.orderNote;
  if (itemsToPrint.length === 0 && !orderNote) { alert('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î½Î­ÎµÏ‚ Î³ÏÎ±Î¼Î¼Î­Ï‚ Î® Î³ÎµÎ½Î¹ÎºÎ­Ï‚ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·.'); return; }
  t.status = 'busy';
  const ts = new Date().toLocaleString('el-GR');
  const printNo = nextPrintNumber();
  const printTotal = calcTotal(itemsToPrint);
  addPrintTotal(printTotal);
  const deviceName = localStorage.getItem('pos_device_name') || 'ORDER_POS';
  let receiptText = `\n[${deviceName}] Table ${currentTable}\nPrint No. #${printNo}\n${ts}\n--------------------------------\n`;
  if (itemsToPrint.length > 0) {
    itemsToPrint.forEach(it => {
      const mods = Object.values(it.mods || {}).join(' | ');
      const freeTag = it.isFree ? ' (FR)' : '';
      const decafTag = it.mods?.coffeeType === 'DECAF' ? ' DECAF' : '';
      receiptText += `${it.qty} x ${it.name}${decafTag}${freeTag}\n`;
      if (mods) receiptText += `  -> ${mods}\n`;
    });
  }
  receiptText += '--------------------------------\n';
  receiptText += `Total: ${euro(printTotal)}\n\n`;
  if (orderNote) receiptText += `ORDER NOTES:\n${orderNote}\n\n`;
  printViaRawBT(receiptText);
  itemsToPrint.forEach(item => { item.isPrinted = true; });
  if (orderNote) { t.orderNote = ''; byId('orderNote').value = ''; }
  saveTables(); renderCart(); renderTablesView();
  showToast(`Print #${printNo} sent`, 'info');
  setTimeout(() => { goBackToTables(); }, 1500);
}
function quickPrint() { if (!currentTable) { showToast('Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ Ï„ÏÎ±Ï€Î­Î¶Î¹', 'warn'); return; } executeAndPrint(); }

// =============== TAKEOUT ===============
function openTakeawayModal() {
  const modal = byId('takeawayModal');
  const taText = byId('takeawayText');
  const customPriceInput = byId('takeawayCustomPrice');
  taText.value = ''; customPriceInput.value = '';
  qsa('.product.active', byId('takeawayPrices')).forEach(p => p.classList.remove('active'));
  modal.classList.add('show'); taText.focus();
}
function setupTakeawayModal() {
  const modalTakeaway = byId('takeawayModal');
  const taText = byId('takeawayText');
  const customPriceInput = byId('takeawayCustomPrice');
  const presetPriceButtons = qsa('#takeawayPrices .product[data-price]');
  let selectedTakeawayPrice = null;
  byId('takeawayCancel').addEventListener('click', () => { modalTakeaway.classList.remove('show'); });
  presetPriceButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      qsa('.product.active', byId('takeawayPrices')).forEach(p => p.classList.remove('active'));
      btn.classList.add('active'); selectedTakeawayPrice = parseFloat(btn.dataset.price); customPriceInput.value = '';
    });
  });
  customPriceInput.addEventListener('input', () => { if (customPriceInput.value) { presetPriceButtons.forEach(btn => btn.classList.remove('active')); selectedTakeawayPrice = null; } });
  byId('takeawayPrint').addEventListener('click', () => {
    const note = taText.value.trim();
    const customPrice = parseFloat(customPriceInput.value);
    let finalPrice = null;
    if (!isNaN(customPrice) && customPrice > 0) finalPrice = customPrice;
    else if (selectedTakeawayPrice !== null) finalPrice = selectedTakeawayPrice;
    if (finalPrice === null) { alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î® ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î½Î± Ï€Î¿ÏƒÏŒ Î³Î¹Î± Ï„Î¿ Ï€Î±ÎºÎ­Ï„Î¿.'); return; }
    if (!note) { alert('Î Î±ÏÎ±ÎºÎ±Î»Ï Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î³Î¹Î± Ï„Î¿ Ï€Î±ÎºÎ­Ï„Î¿.'); return; }
    printTakeaway(finalPrice, note); modalTakeaway.classList.remove('show');
  });
}
function printTakeaway(price, noteText) {
  const ts = new Date().toLocaleString('el-GR');
  const printNo = nextPrintNumber();
  incrementTakeoutCount(); addPrintTotal(price);
  const deviceName = localStorage.getItem('pos_device_name') || 'ORDER_POS';
  let receiptText = `\n[${deviceName}] TAKEAWAY\nPrint No. #${printNo}\n${ts}\n--------------------------------\nÎ ÎŸÎ£ÎŸ: ${euro(price)}\n\nÎ£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚:\n${noteText}\n\n`;
  printViaRawBT(receiptText); showToast(`Takeaway Print #${printNo} sent`, 'info');
}

// =============== TRANSFER ===============
function openTransferModal() {
  if (!currentTable) return;
  selectedItemsForTransfer = []; transferTargetTable = null;
  const modal = byId('transferModal'), modalContentEl = byId('transferModalContent');
  modal.querySelector('.modal-header h3').textContent = 'Î•Ï€Î¹Î»Î¿Î³Î® Î ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½';
  modalContentEl.innerHTML = `
    <div style="padding: 20px; text-align: center;">
      <h3 style="margin-bottom: 20px; color: var(--accent-yellow);">Î•Ï€Î¹Î»Î¿Î³Î® Î ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½ Î³Î¹Î± ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬</h3>
      <p style="margin-bottom: 25px; color: var(--text-muted);">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Ï€Î¿Ï… Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î¼ÎµÏ„Î±Ï†Î­ÏÎµÏ„Îµ Î±Ï€ÏŒ Ï„Î¿ Ï„ÏÎ±Ï€Î­Î¶Î¹ ${currentTable}:</p>
      <div style="margin-bottom: 25px;">
        <button class="btn accent" id="selectAllBtn" style="margin-bottom: 15px;">Î•Ï€Î¹Î»Î¿Î³Î® ÎŒÎ»Ï‰Î½</button>
        <button class="btn ghost" id="deselectAllBtn" style="margin-bottom: 15px;">Î‘Ï€Î¿ÎµÏ€Î¹Î»Î¿Î³Î® ÎŒÎ»Ï‰Î½</button>
      </div>
      <div id="transferItemsContainer" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 10px; background: var(--bg-muted); border-radius: 10px;"></div>
      <div style="margin-top: 20px; padding: 15px; background: var(--gray-300); border-radius: 10px;">
        <p style="margin: 0; font-weight: 600; color: var(--accent-yellow);">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±: <span id="selectedCount">0</span> / <span id="totalCount">0</span></p>
        <p style="margin: 5px 0 0 0; font-size: 14px; color: var(--text-muted);">Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Ï€Î¿ÏƒÏŒ: <span id="selectedTotal">0.00â‚¬</span></p>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button class="btn ghost" id="transferCancelBtn" style="flex: 1;">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        <button class="btn success" id="transferProceedBtn" style="flex: 2;">Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±</button>
      </div>
    </div>`;
  openModal('transferModal');
  renderTransferItemsForSelection();
  setTimeout(() => {
    byId('selectAllBtn')?.addEventListener('click', () => selectAllItems());
    byId('deselectAllBtn')?.addEventListener('click', () => deselectAllItems());
    byId('transferProceedBtn')?.addEventListener('click', () => {
      if (selectedItemsForTransfer.length === 0) { showToast('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½.', 'warn'); return; }
      showTransferStep2();
    });
    byId('transferCancelBtn')?.addEventListener('click', () => closeModal('transferModal'));
  }, 50);
}
function renderTransferItemsForSelection() {
  const container = byId('transferItemsContainer');
  const items = tables[currentTable].items;
  if (items.length === 0) {
    container.innerHTML = '<div class="empty-cart">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Î³Î¹Î± Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬</div>';
    byId('selectedCount').textContent = byId('totalCount').textContent = '0';
    byId('selectedTotal').textContent = '0.00â‚¬';
    return;
  }
  container.innerHTML = '';
  items.forEach((item, index) => {
    const mods = Object.values(item.mods || {}).join(' â€¢ ');
    const div = document.createElement('div');
    div.className = `transfer-item-selectable ${item.isPrinted ? 'printed' : ''}`;
    div.style.padding = '12px'; div.style.borderBottom = '1px dashed var(--gray-400)'; div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.justifyContent = 'space-between';
    div.innerHTML = `
      <div style="display: flex; align-items: center; flex: 1;">
        <input type="checkbox" class="transfer-checkbox" data-index="${index}" id="transferCheckbox${index}" ${selectedItemsForTransfer.includes(index) ? 'checked' : ''}>
        <div style="margin-left: 10px;">
          <div><strong>${item.qty} x ${item.name}</strong>${item.isPrinted ? ' <span style="color: var(--warning); font-size: 12px;">(Î•ÎºÏ„Ï…Ï€Ï‰Î¼Î­Î½Î¿)</span>' : ''}</div>
          ${mods ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${mods}</div>` : ''}
        </div>
      </div>
      <div style="font-weight: bold; margin-left: 15px;">${euro(item.lineTotal)}</div>`;
    container.appendChild(div);
    const checkbox = div.querySelector(`#transferCheckbox${index}`);
    checkbox.addEventListener('change', (e) => {
      const idx = parseInt(e.target.dataset.index);
      if (e.target.checked) { if (!selectedItemsForTransfer.includes(idx)) selectedItemsForTransfer.push(idx); }
      else selectedItemsForTransfer = selectedItemsForTransfer.filter(i => i !== idx);
      updateSelectionSummary();
    });
  });
  byId('totalCount').textContent = items.length;
  updateSelectionSummary();
}
function selectAllItems() {
  const items = tables[currentTable].items;
  selectedItemsForTransfer = Array.from({ length: items.length }, (_, i) => i);
  qsa('.transfer-checkbox').forEach(cb => cb.checked = true);
  updateSelectionSummary();
}
function deselectAllItems() {
  selectedItemsForTransfer = [];
  qsa('.transfer-checkbox').forEach(cb => cb.checked = false);
  updateSelectionSummary();
}
function updateSelectionSummary() {
  const items = tables[currentTable].items;
  const selectedCount = selectedItemsForTransfer.length;
  const selectedTotal = selectedItemsForTransfer.reduce((sum, idx) => sum + (items[idx]?.lineTotal || 0), 0);
  byId('selectedCount').textContent = selectedCount;
  byId('selectedTotal').textContent = euro(selectedTotal);
  const proceedBtn = byId('transferProceedBtn');
  if (proceedBtn) { proceedBtn.textContent = `Î£Ï…Î½Î­Ï‡ÎµÎ¹Î± (${selectedCount} Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±)`; proceedBtn.disabled = selectedCount === 0; }
}
function showTransferStep2() {
  const modal = byId('transferModal'), modalContentEl = byId('transferModalContent');
  const items = tables[currentTable].items;
  const selectedItems = selectedItemsForTransfer.map(idx => items[idx]);
  const selectedTotal = selectedItems.reduce((sum, item) => sum + item.lineTotal, 0);
  modal.querySelector('.modal-header h3').textContent = 'Î•Ï€Î¹Î»Î¿Î³Î® Î¤ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï Î ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼Î¿Ï';
  modalContentEl.innerHTML = `
    <div style="padding: 15px;">
      <p><strong>Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±:</strong> ${selectedItemsForTransfer.length} Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î±</p>
      <p><strong>Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Ï€Î¿ÏƒÏŒ:</strong> ${euro(selectedTotal)}</p>
      <div style="max-height: 200px; overflow-y: auto; margin: 15px 0; padding: 10px; background: var(--bg-muted); border-radius: 10px;">
        ${selectedItems.map((item, i) => `
          <div style="padding: 8px; border-bottom: 1px dashed var(--border-light); ${i === selectedItems.length - 1 ? 'border-bottom: none;' : ''}">
            <div style="display: flex; justify-content: space-between;">
              <div><strong>${item.qty} x ${item.name}</strong>${item.isPrinted ? ' <span style="color: var(--warning); font-size: 12px;">(Î•ÎºÏ„Ï…Ï€Ï‰Î¼Î­Î½Î¿)</span>' : ''}</div>
              <div>${euro(item.lineTotal)}</div>
            </div>
            ${Object.values(item.mods || {}).length > 0 ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">${Object.values(item.mods || {}).join(' â€¢ ')}</div>` : ''}
          </div>`).join('')}
      </div>
      <p style="margin-top: 25px;"><strong>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÎ±Ï€Î­Î¶Î¹ Ï€ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼Î¿Ï:</strong></p>
      <div class="tables-grid" id="tablesTransferGrid"></div>
    </div>`;
  hideEl(byId('transferNextBtn'));
  showEl(byId('transferConfirmBtn'));
  byId('transferConfirmBtn').textContent = `ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ ${selectedItemsForTransfer.length} Î ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½`;
  renderTransferTables();
}
function renderTransferTables() {
  const tablesTransferGrid = byId('tablesTransferGrid');
  tablesTransferGrid.innerHTML = '';
  Object.keys(tables).forEach(num => {
    if (parseInt(num) !== currentTable) {
      const t = tables[num];
      const btn = document.createElement('button');
      btn.className = `table-btn ${t.status === 'free' ? 'free' : 'busy'}`;
      btn.innerHTML = `<div>Î¤Ï. ${num}</div><div class="table-total">${euro(t.total)}</div>`;
      btn.addEventListener('click', () => {
        qsa('#tablesTransferGrid .table-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        transferTargetTable = parseInt(num, 10);
      });
      tablesTransferGrid.appendChild(btn);
    }
  });
}
function executeTransfer() {
  const source = currentTable, target = transferTargetTable;
  if (!source || !target || selectedItemsForTransfer.length === 0) { showToast('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÎ±Ï€Î­Î¶Î¹ Ï€ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼Î¿Ï.', 'warn'); return; }
  const sourceData = tables[source], targetData = tables[target];
  const sortedIndices = [...selectedItemsForTransfer].sort((a, b) => b - a);
  sortedIndices.forEach(index => {
    const itemToTransfer = sourceData.items[index];
    const transferredItem = {...itemToTransfer, mods: {...itemToTransfer.mods}};
    sourceData.items.splice(index, 1);
    targetData.items.push(transferredItem);
  });
  sourceData.total = calcTotal(sourceData.items);
  sourceData.status = sourceData.items.length > 0 ? 'busy' : 'free';
  targetData.total = calcTotal(targetData.items);
  targetData.status = 'busy';
  saveTables();
  const transferredCount = sortedIndices.length;
  const printedCount = sortedIndices.filter(idx => tables[source].items[idx]?.isPrinted).length;
  const printedText = printedCount > 0 ? ` (${printedCount} ÎµÎºÏ„Ï…Ï€Ï‰Î¼Î­Î½Î±)` : '';
  closeModal('transferModal');
  renderCart();
  renderTablesView();
  showToast(`ÎœÎµÏ„Î±Ï†Î­ÏÎ¸Î·ÎºÎ±Î½ ${transferredCount} Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± ÏƒÏ„Î¿ Î¤Ï. ${target}${printedText}`, 'success');
  selectedItemsForTransfer = []; transferTargetTable = null;
}
function setupTransferModal() {
  byId('transferCancel').addEventListener('click', () => { closeModal('transferModal'); selectedItemsForTransfer = []; transferTargetTable = null; });
  byId('transferNextBtn').addEventListener('click', () => { if (selectedItemsForTransfer.length === 0) { showToast('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î± Ï€ÏÎ¿ÏŠÏŒÎ½.', 'warn'); return; } showTransferStep2(); });
  byId('transferConfirmBtn').addEventListener('click', () => { if (!transferTargetTable) { showToast('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î­Î½Î± Ï„ÏÎ±Ï€Î­Î¶Î¹ Ï€ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼Î¿Ï.', 'warn'); return; } executeTransfer(); });
}

// =============== PIN SYSTEM ===============
function setupPinSystem() {
  const PIN_CODE = '2691', pinInput = byId('pinInput'), pinModal = byId('pinModal');
  let pinAction = null;
  byId('pinCancel').addEventListener('click', () => { pinModal.classList.remove('show'); pinAction = null; });
  pinInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') byId('pinOk').click(); });
  byId('pinOk').addEventListener('click', () => {
    if (pinInput.value === PIN_CODE) {
      const currentAction = pinAction; pinModal.classList.remove('show'); pinInput.value = ''; pinAction = null;
      if (currentAction === 'applyTotalDiscount') applyTotalDiscount();
      else if (currentAction === 'endShift') endShift();
      else if (currentAction === 'openAdmin') openAdminPanel();
    } else { alert('Î›Î¬Î¸Î¿Ï‚ PIN. Î ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î¾Î±Î½Î¬.'); pinInput.value = ''; pinInput.focus(); }
  });
  byId('btnAdmin').addEventListener('click', () => { pinInput.value = ''; pinAction = 'openAdmin'; byId('pinModalTitle').textContent = 'Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® PIN Î³Î¹Î± Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·'; pinModal.classList.add('show'); pinInput.focus(); });
  byId('btnDiscount').addEventListener('click', () => { pinInput.value = ''; pinAction = 'applyTotalDiscount'; byId('pinModalTitle').textContent = 'Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® PIN Î³Î¹Î± Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Î Î¿ÏƒÎ¿Ï'; pinModal.classList.add('show'); pinInput.focus(); });
  byId('btnEndShift').addEventListener('click', () => { pinInput.value = ''; pinAction = 'endShift'; byId('pinModalTitle').textContent = 'Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® PIN Î³Î¹Î± Î¤Î­Î»Î¿Ï‚ Î’Î¬ÏÎ´Î¹Î±Ï‚'; pinModal.classList.add('show'); pinInput.focus(); });
}
function endShift() {
  const printCount = getPrintCounter(), totalAmount = getPrintTotal(), takeoutCount = getTakeoutCount();
  const discountTotal = getDiscountTotal(), netTotal = totalAmount - discountTotal;
  const freeCount = getFreeCount(); // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: ÎœÎµÏ„ÏÎ·Ï„Î®Ï‚ FREE Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
  
  const msg = `Î¤Î­Î»Î¿Ï‚ Î’Î¬ÏÎ´Î¹Î±Ï‚\n\n` +
    `Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚: ${printCount}\n` +
    `Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î¤Î¶Î¯ÏÎ¿Ï‚ (Î ÏÎ¹Î½ Î‘Ï†Î±Î¯ÏÎµÏƒÎ·): ${euro(totalAmount)}\n` +
    `Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î‘Ï†Î±Î¯ÏÎµÏƒÎ·: ${euro(discountTotal)}\n` +
    `ÎšÎ±Î¸Î±ÏÏŒÏ‚ Î¤Î¶Î¯ÏÎ¿Ï‚: ${euro(netTotal)}\n\n` +
    `Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚ Î Î±ÎºÎ­Ï„Ï‰Î½: ${takeoutCount}\n` +
    `FREE Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±: ${freeCount}\n\n` + // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ FREE Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
    `Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î¼Î·Î´ÎµÎ½Î¯ÏƒÎµÏ„Îµ Ï„Î¿Ï…Ï‚ Î¼ÎµÏ„ÏÎ·Ï„Î­Ï‚;`;
    
  const ok = confirm(msg);
  ok ? (
    setPrintCounter(0), 
    setPrintTotal(0), 
    setTakeoutCount(0), 
    setDiscountTotal(0),
    setFreeCount(0), // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚ Î¼ÎµÏ„ÏÎ·Ï„Î® FREE Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
    showToast('ÎŸÎ¹ Î¼ÎµÏ„ÏÎ·Ï„Î­Ï‚ Î¼Î·Î´ÎµÎ½Î¯ÏƒÏ„Î·ÎºÎ±Î½.', 'success')
  ) : showToast('ÎŸÎ¹ Î¼ÎµÏ„ÏÎ·Ï„Î­Ï‚ Ï€Î±ÏÎ­Î¼ÎµÎ¹Î½Î±Î½ Ï‰Ï‚ Î­Ï‡Î¿Ï…Î½.', 'info');
}
function applyTotalDiscount() {
  const discountText = prompt("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ Ï€Î¿ÏƒÏŒ Ï€ÏÎ¿Ï‚ Î±Ï†Î±Î¯ÏÎµÏƒÎ· (Ï€.Ï‡. 3.00):");
  const discountAmount = parseFloat(discountText);
  if (isNaN(discountAmount) || discountAmount <= 0) { showToast('Î†ÎºÏ…ÏÎ¿ Ï€Î¿ÏƒÏŒ Ï€ÏÎ¿Ï‚ Î±Ï†Î±Î¯ÏÎµÏƒÎ·.', 'danger', 3000); return; }
  addDiscountTotal(discountAmount);
  printDiscountReceipt(discountAmount);
  showToast(`ÎšÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ Î‘Ï†Î±Î¯ÏÎµÏƒÎ·: ${euro(discountAmount)}`, 'success', 4000);
}
function printDiscountReceipt(amount) {
  const ts = new Date().toLocaleString('el-GR'); const printNo = nextPrintNumber();
  let receiptText = `\nPOS DISCOUNT\nPrint No. #${printNo}\n${ts}\n--------------------------------\nÎ‘Ï†Î±Î¯ÏÎµÏƒÎ·: -${euro(amount)}\n--------------------------------\n\n`;
  printViaRawBT(receiptText);
}

// =============== CATALOG MANAGEMENT ===============
function setupCatalogManagement() {
  byId('addProductBtn').addEventListener('click', () => showProductForm());
  byId('resetCatalogBtn').addEventListener('click', () => {
    if (confirm("Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î•Î Î‘ÎÎ‘Î¦Î•Î¡Î•Î¤Î• Ï„Î¿Î½ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿ ÏƒÏ„Î¹Ï‚ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½ÎµÏ‚ Ï„Î¹Î¼Î­Ï‚;")) {
      catalog = JSON.parse(JSON.stringify(defaultCatalog)); saveCatalog(); renderAdminCatalog();
      showToast('ÎŸ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿Ï‚ ÎµÏ€Î±Î½Î±Ï†Î­ÏÎ¸Î·ÎºÎµ ÏƒÏ„Î¹Ï‚ Î±ÏÏ‡Î¹ÎºÎ­Ï‚ Ï„Î¹Î¼Î­Ï‚.', 'success');
    }
  });
  byId('saveProductBtn').addEventListener('click', saveProduct);
  byId('clearCatalogBtn').addEventListener('click', clearCatalog);
  byId('exportCatalogBtn').addEventListener('click', exportCatalog);
  byId('importCatalogBtn').addEventListener('click', () => byId('catalogFileInput').click());
  byId('catalogFileInput').addEventListener('change', handleCatalogFileImport);
  byId('saveDeviceNameBtn').addEventListener('click', saveDeviceName);
}
function saveDeviceName() {
  const newName = byId('deviceNameInput').value.trim();
  if (!newName) { showToast('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ ÏŒÎ½Î¿Î¼Î± ÏƒÏ…ÏƒÎºÎµÏ…Î®Ï‚', 'warn'); return; }
  localStorage.setItem('pos_device_name', newName);
  byId('currentDeviceNamePreview').textContent = newName;
  showToast(`ÎŸÎ½Î¿Î¼Î±ÏƒÎ¯Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ: ${newName}`, 'success');
}
function clearCatalog() {
  if (!confirm("âš ï¸ Î•Î™Î£Î‘Î™ Î£Î™Î“ÎŸÎ¥Î¡ÎŸÎ£;\n\nÎ‘Ï…Ï„Î® Î· ÎµÎ½Î­ÏÎ³ÎµÎ¹Î± Î¸Î± Î‘Î”Î•Î™Î‘Î£Î•Î™ ÎŸÎ›ÎŸÎšÎ›Î—Î¡ÎŸÎ Ï„Î¿Î½ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿.\nÎŒÎ»ÎµÏ‚ Î¿Î¹ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ Î¸Î± Î³Î¯Î½Î¿Ï…Î½ ÎºÎµÎ½Î­Ï‚.")) return;
  catalog = { coffee: [], soft: [], juices: [], drinks: [], food: [] };
  saveCatalog(); renderAdminCatalog();
  showToast('ÎŸ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿Ï‚ ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ Ï€Î»Î®ÏÏ‰Ï‚.', 'success', 4000);
}
function exportCatalog() {
  const catalogData = { coffee: catalog.coffee || [], soft: catalog.soft || [], juices: catalog.juices || [], drinks: catalog.drinks || [], food: catalog.food || [] };
  const jsonString = JSON.stringify(catalogData, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `pos_catalog_${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('ÎŸ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿Ï‚ ÎµÎ¾Î®Ï‡Î¸Î· ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success');
}
function handleCatalogFileImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedCatalog = JSON.parse(e.target.result);
      const requiredCategories = ['coffee', 'soft', 'juices', 'drinks', 'food'];
      const hasAllCategories = requiredCategories.every(cat => importedCatalog.hasOwnProperty(cat));
      const allCategoriesAreArrays = requiredCategories.every(cat => Array.isArray(importedCatalog[cat]));
      if (!hasAllCategories || !allCategoriesAreArrays) { showToast('Î›Î¬Î¸Î¿Ï‚ Î´Î¿Î¼Î® JSON', 'danger', 5000); return; }
      let isValidStructure = true;
      for (const category of requiredCategories) {
        for (const product of importedCatalog[category]) {
          if (!product.name || typeof product.price !== 'number') { isValidStructure = false; break; }
        }
        if (!isValidStructure) break;
      }
      if (!isValidStructure) { showToast('Î›Î¬Î¸Î¿Ï‚ Î´Î¿Î¼Î® JSON: ÎšÎ¬Î¸Îµ Ï€ÏÎ¿ÏŠÏŒÎ½ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ "name" ÎºÎ±Î¹ "price".', 'danger', 5000); return; }
      const totalProducts = requiredCategories.reduce((sum, cat) => sum + importedCatalog[cat].length, 0);
      if (!confirm(`Î’ÏÎ­Î¸Î·ÎºÎ±Î½ ${totalProducts} Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± ÏƒÏ„Î¿Î½ Î½Î­Î¿ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿.\n\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎµÏ„Îµ ÎŸÎ›ÎŸÎšÎ›Î—Î¡ÎŸ Ï„Î¿Î½ Ï„ÏÎ­Ï‡Ï‰Î½ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿ Î¼Îµ Ï„Î± Î½Î­Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±;`)) { showToast('Î— ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® Î±ÎºÏ…ÏÏÎ¸Î·ÎºÎµ.', 'info'); return; }
      catalog = importedCatalog;
      saveCatalog(); renderAdminCatalog();
      showToast(`ÎŸ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿Ï‚ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ ${totalProducts} Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±.`, 'success', 4000);
    } catch (error) { showToast(`Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Î½Î¬Î³Î½Ï‰ÏƒÎ· Ï„Î¿Ï… JSON Î±ÏÏ‡ÎµÎ¯Î¿Ï…: ${error.message}`, 'danger', 5000); }
    event.target.value = '';
  };
  reader.readAsText(file);
}
function openAdminPanel() { renderAdminCatalog(); openModal('catalogModal'); }
function renderAdminCatalog() {
  const catalogListContainer = byId('catalogListContainer');
  catalogListContainer.innerHTML = '';
  Object.keys(CATEGORIES).forEach(key => {
    const products = catalog[key] || [];
    const categorySection = document.createElement('div');
    categorySection.style.marginBottom = '20px';
    categorySection.innerHTML = `<h4 style="border-bottom: 1px solid var(--gray-400); padding-bottom: 5px;">${CATEGORIES[key]} (${products.length} Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±)</h4>`;
    const list = document.createElement('ul');
    list.className = 'catalog-admin-list'; list.setAttribute('data-category', key);
    products.forEach((p, index) => {
      const item = document.createElement('li');
      item.className = 'catalog-admin-item';
      item.innerHTML = `<div class="product-info">
        <span class="drag-handle">â˜°</span>
        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
          <div class="product-name">${p.name}</div>
          <div class="product-details">${euro(p.price)}${p.tag ? ` â€¢ ${p.tag}` : ''}</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost edit-product" data-category="${key}" data-index="${index}">âœ</button>
        <button class="btn danger remove-product" data-category="${key}" data-index="${index}">âœ•</button>
      </div>`;
      list.appendChild(item);
    });
    categorySection.appendChild(list); catalogListContainer.appendChild(categorySection);
    new Sortable(list, { animation: 150, handle: '.drag-handle', onEnd: (evt) => {
      const category = evt.to.dataset.category;
      const movedItem = catalog[category].splice(evt.oldIndex, 1)[0];
      catalog[category].splice(evt.newIndex, 0, movedItem); saveCatalog();
    }});
    qsa('.edit-product', list).forEach(btn => btn.addEventListener('click', (e) => { showProductForm(e.target.dataset.category, parseInt(e.target.dataset.index)); }));
    qsa('.remove-product', list).forEach(btn => btn.addEventListener('click', (e) => {
      if (!confirm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚ "${catalog[e.target.dataset.category][e.target.dataset.index].name}";`)) return;
      catalog[e.target.dataset.category].splice(e.target.dataset.index, 1); saveCatalog(); renderAdminCatalog();
      showToast('Î¤Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ.', 'info');
    }));
  });
}
function showProductForm(category = null, index = null) {
  const formTitle = byId('productFormTitle'), saveBtn = byId('saveProductBtn');
  const categorySelect = byId('productCategory'); categorySelect.innerHTML = '';
  Object.keys(CATEGORIES).forEach(cat => { categorySelect.innerHTML += `<option value="${cat}">${CATEGORIES[cat]}</option>`; });
  if (category !== null && index !== null) {
    editingProductId = { category, index }; formTitle.textContent = 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚'; saveBtn.textContent = 'Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·';
    const product = catalog[category][index];
    byId('productName').value = product.name; byId('productPrice').value = product.price;
    byId('productCategory').value = category; byId('productTag').value = product.tag || '';
  } else {
    editingProductId = null; formTitle.textContent = 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚'; saveBtn.textContent = 'Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·';
    byId('productName').value = ''; byId('productPrice').value = ''; byId('productCategory').value = 'coffee'; byId('productTag').value = '';
  }
  openModal('productFormModal');
}
function saveProduct() {
  const name = byId('productName').value.trim(); const price = parseFloat(byId('productPrice').value);
  const category = byId('productCategory').value; const tag = byId('productTag').value.trim() || undefined;
  if (!name || isNaN(price) || price <= 0 || !category) { alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏƒÏ‰ÏƒÏ„Î¬ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î±.'); return; }
  if (editingProductId) {
    const { category: oldCategory, index } = editingProductId;
    if (oldCategory !== category) { catalog[oldCategory].splice(index, 1); if (!catalog[category]) catalog[category] = []; catalog[category].push({ name, price, tag }); }
    else { catalog[category][index] = { name, price, tag }; }
    showToast('Î¤Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ!', 'success');
  } else {
    const newProduct = { name, price, tag }; if (!catalog[category]) catalog[category] = []; catalog[category].push(newProduct);
    showToast('Î¤Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!', 'success');
  }
  saveCatalog(); renderAdminCatalog(); closeModal('productFormModal');
}

// =============== INITIALIZATION ===============
document.addEventListener('DOMContentLoaded', () => {
  loadCatalog(); loadTables(); setupEventListeners(); renderTablesView();
  setupReprintModal(); 
  
  qsa('.btn, .tab, .product, .chip, .table-btn').forEach(el => el.addEventListener('click', function() { addClickEffect(this); }));
  const savedName = localStorage.getItem('pos_device_name') || 'ORDER_POS';
  byId('deviceNameInput').value = savedName; byId('currentDeviceNamePreview').textContent = savedName;
});

function setupEventListeners() {
  byId('backToTables').addEventListener('click', goBackToTables);
  qsa('.tab').forEach(btn => btn.addEventListener('click', () => {
    qsa('.tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    switchTab(btn.dataset.tab);
  }));
  byId('openCartBtn').addEventListener('click', openCartModal);
  byId('quickPrintBtn').addEventListener('click', quickPrint);
  byId('printNow').addEventListener('click', executeAndPrint);
  byId('clearDraft').addEventListener('click', clearDraft);
  byId('closeTable').addEventListener('click', closeTable);
  byId('transferTable').addEventListener('click', openTransferModal);
  byId('orderNote').addEventListener('input', function() {
    if (currentTable) { tables[currentTable].orderNote = this.value; saveTables(); }
  });
  setupPinSystem(); setupTakeawayModal(); setupTransferModal(); setupCatalogManagement();
  byId('closeModifiers').addEventListener('click', () => closeModal('modifiersModal'));
  byId('closeCart').addEventListener('click', () => closeModal('cartModal'));
  byId('catalogModalClose').addEventListener('click', () => closeModal('catalogModal'));
  byId('productFormClose').addEventListener('click', () => closeModal('productFormModal'));
}

function goBackToTables() {
  showEl(byId('tablesView')); hideEl(byId('orderView')); currentTable = null;
  renderTablesView(); showToast('Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î± Ï„ÏÎ±Ï€Î­Î¶Î¹Î±', 'info');
}

function openCartModal() {
  const modalContent = byId('cartModalContent');
  modalContent.innerHTML = createCartModalContent();
  openModal('cartModal');
}

function createCartModalContent() {
  if (!currentTable) return '<div class="empty-cart">Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ Ï„ÏÎ±Ï€Î­Î¶Î¹</div>';
  const t = tables[currentTable];
  let html = `<div style="padding: 10px;"><h4 style="margin-top: 0;">Î¤ÏÎ±Ï€Î­Î¶Î¹ ${currentTable}</h4>`;
  if (t.items.length === 0) html += '<div class="empty-cart">Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿</div>';
  else {
    t.items.forEach((it, i) => {
      const mods = Object.values(it.mods || {}).join(' â€¢ ');
      const lineTotal = it.isFree ? 'FREE' : euro(it.lineTotal);
      const printedClass = it.isPrinted ? 'printed' : '';
      html += `<div class="cart-item ${printedClass}" style="margin-bottom: 10px; padding: 10px; background: var(--bg-muted); border-radius: 8px;">
        <div><strong>${it.qty} x ${it.name}</strong>${mods ? `<div class="meta">${mods}</div>` : ''}</div>
        <div style="font-weight: bold; color: ${it.isFree ? 'var(--success)' : ''};">${lineTotal}</div>
        <div style="display: flex; gap: 5px; margin-top: 5px;">
          <button class="btn remove-small" data-index="${i}" style="padding: 3px 6px; font-size: 11px; background: transparent; color: var(--danger); border: 1px solid var(--danger);">âœ•</button>
          ${!it.isPrinted ? `<button class="btn edit-item-small" data-index="${i}" style="padding: 3px 6px; font-size: 11px; background: transparent; color: var(--warning); border: 1px solid var(--warning);">âœ</button>` : ''}
        </div></div>`;
    });
    html += `<div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--accent-yellow);">
      <div style="display: flex; justify-content: space-between; font-size: 18px;"><strong>Î£ÏÎ½Î¿Î»Î¿:</strong><strong>${euro(t.total)}</strong></div></div>
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button class="btn" id="modalCloseCart" style="flex: 1;">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
        <button class="btn success" id="modalPrintFromCart" style="flex: 2;">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
      </div>`;
  }
  html += '</div>';
  setTimeout(() => {
    const closeBtn = byId('modalCloseCart'); const printBtn = byId('modalPrintFromCart');
    if (closeBtn) closeBtn.addEventListener('click', () => closeModal('cartModal'));
    if (printBtn) printBtn.addEventListener('click', () => { executeAndPrint(); closeModal('cartModal'); });
    qsa('.remove-small').forEach(btn => { btn.addEventListener('click', (e) => { removeCartItem(parseInt(e.target.dataset.index)); openCartModal(); }); });
    qsa('.edit-item-small').forEach(btn => { btn.addEventListener('click', (e) => { closeModal('cartModal'); editCartItem(parseInt(e.target.dataset.index)); }); });
  }, 100);
  return html;
}
</script>
</body>

</html>

